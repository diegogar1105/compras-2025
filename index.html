<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Offline (Bs. / USD)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de Tailwind para usar el color primario y la fuente Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-bs': '#4a7c59', // Tono de verde amigable (Verde)
                        'secondary-usd': '#003865', // Azul oscuro (USD)
                        'warning-bs': '#ffc107', // Amarillo para advertencias/saldo
                        'edit-color': '#f97316', // Naranja para el modo edición
                        'danger': '#dc2626', // Rojo
                        'success': '#16a34a', // Verde de éxito
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Carga de la fuente Inter de Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Carga de las librerías jspdf y jspdf-autotable para generar el PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Estilos de scrollbar personalizados */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* gris claro */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8; /* gris medio */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8 font-sans">

    <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-xl p-4 sm:p-8">

        <!-- Encabezado y Configuración -->
        <header class="mb-8 border-b pb-4">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Inventario Offline</h1>
            <p class="text-gray-500">Gestión de productos y cálculo de valor en Bolívares (Bs.) y Dólares (USD).</p>
        </header>
      
        <!-- Configuración Financiera (Tasa de Cambio y Saldo) -->
        <section class="bg-blue-50 border-l-4 border-secondary-usd p-4 rounded-lg mb-8 shadow-inner">
            <h2 class="text-xl font-semibold text-secondary-usd mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                Configuración y Saldo
            </h2>
            <form id="config-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="exchange-rate" class="block text-sm font-medium text-gray-700">Tasa de Cambio (USD a Bs.)</label>
                    <input type="number" id="exchange-rate" step="0.01" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-secondary-usd focus:ring-secondary-usd p-2 border"
                           placeholder="Ej: 36.50">
                    <p class="text-xs text-gray-500 mt-1">Se usa para conversiones automáticas.</p>
                </div>
                <div>
                    <label for="initial-balance-bs" class="block text-sm font-medium text-gray-700">Saldo Inicial (Bs.)</label>
                    <input type="number" id="initial-balance-bs" step="0.01" value="0.00"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-secondary-usd focus:ring-secondary-usd p-2 border"
                           placeholder="0.00">
                    <p class="text-xs text-gray-500 mt-1">Opcional. Para cálculo de saldo restante.</p>
                </div>
                <button type="submit" class="md:col-span-2 bg-secondary-usd text-white py-2 px-4 rounded-md hover:bg-blue-900 transition-colors font-semibold shadow-md">
                    Guardar Configuración
                </button>
            </form>
        </section>

        <!-- Formulario para Agregar/Editar Productos -->
        <section class="bg-gray-50 p-6 rounded-xl shadow-lg mb-8">
            <h2 id="form-title" class="text-2xl font-bold text-primary-bs mb-4">Agregar Nuevo Producto</h2>
            <form id="product-form" data-mode="add">
                <!-- Campo oculto para el ID del producto en modo edición -->
                <input type="hidden" id="product-id">

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <!-- Nombre del Producto -->
                    <div class="md:col-span-2">
                        <label for="product-name" class="block text-sm font-medium text-gray-700">Nombre del Producto</label>
                        <input type="text" id="product-name" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-bs focus:ring-primary-bs p-2 border"
                               placeholder="Ej: Harina de Maíz">
                    </div>

                    <!-- Cantidad -->
                    <div>
                        <label for="product-quantity" class="block text-sm font-medium text-gray-700">Cantidad (Unidades)</label>
                        <input type="number" id="product-quantity" required min="1"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-bs focus:ring-primary-bs p-2 border"
                               placeholder="1">
                    </div>
                  
                    <!-- Precio en USD -->
                    <div>
                        <label for="price-usd" class="block text-sm font-medium text-gray-700">Precio Unitario (USD)</label>
                        <input type="number" id="price-usd" step="0.01" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-bs focus:ring-primary-bs p-2 border"
                               placeholder="0.00">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <!-- Precio en Bs. (Campo de información, editable solo si no hay USD) -->
                    <div class="md:col-span-2">
                        <label for="price-bs" class="block text-sm font-medium text-gray-700">Precio Unitario (Bs.)</label>
                        <input type="number" id="price-bs" step="0.01" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-bs focus:ring-primary-bs p-2 border"
                               placeholder="0.00">
                        <p id="conversion-info" class="text-xs text-gray-500 mt-1"></p>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="md:col-span-2 flex justify-end space-x-3 mt-6">
                        <button type="button" id="cancel-edit-btn" class="hidden bg-gray-400 text-white py-2 px-4 rounded-md hover:bg-gray-600 transition-colors font-semibold shadow-md">
                            Cancelar Edición
                        </button>
                        <button type="submit" id="submit-btn" class="bg-primary-bs text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors font-semibold shadow-md flex-grow">
                            Agregar Producto
                        </button>
                    </div>
                </div>
            </form>
        </section>

        <!-- Tabla de Inventario -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Detalle del Inventario</h2>
            <div class="overflow-x-auto rounded-lg shadow-xl border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                            <th scope="col" class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">USD Unitario</th>
                            <th scope="col" class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Bs. Unitario</th>
                            <th scope="col" class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total USD</th>
                            <th scope="col" class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Bs.</th>
                            <th scope="col" class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Filas de productos se insertarán aquí -->
                    </tbody>
                </table>
            </div>
            <div id="empty-state" class="text-center py-10 text-gray-500 hidden">
                <p>El inventario está vacío. ¡Agrega tu primer producto!</p>
            </div>
        </section>
      
        <!-- Resumen del Inventario y Acciones -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Resumen Total -->
            <div class="md:col-span-2 bg-white border border-gray-200 p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Resumen General</h3>
                <div id="summary-section" class="space-y-3">
                    <div class="flex justify-between items-center text-lg">
                        <span class="font-medium text-gray-600">Total General (USD):</span>
                        <span id="total-usd" class="font-bold text-secondary-usd text-2xl">$0.00</span>
                    </div>
                    <div class="flex justify-between items-center text-lg">
                        <span class="font-medium text-gray-600">Total General (Bs.):</span>
                        <span id="total-bs" class="font-bold text-primary-bs text-2xl">Bs. 0.00</span>
                    </div>
                    <!-- Sección de Saldo (se muestra solo si se establece un saldo inicial) -->
                    <div id="balance-summary" class="hidden pt-4 border-t border-dashed mt-4 space-y-3">
                        <div class="flex justify-between items-center text-base">
                            <span class="font-medium text-gray-600">Saldo Inicial (Bs.):</span>
                            <span id="initial-balance-display" class="font-bold text-gray-800">Bs. 0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-2xl font-bold">
                            <span class="font-bold text-gray-800">Saldo Restante:</span>
                            <span id="remaining-bs" class="text-success">Bs. 0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="font-medium text-gray-600">Equivalente a (USD):</span>
                            <span id="remaining-usd" class="font-bold text-secondary-usd">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Acciones y Exportar -->
            <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Acciones</h3>
                <div class="space-y-3">
                    <button id="export-pdf-btn" class="w-full bg-red-600 text-white py-3 px-4 rounded-md hover:bg-red-700 transition-colors font-semibold shadow-md flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        Exportar a PDF
                    </button>
                    <button id="clear-inventory-btn" class="w-full bg-danger text-white py-3 px-4 rounded-md hover:bg-red-700 transition-colors font-semibold shadow-md flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                        Limpiar Inventario
                    </button>
                    <div id="clear-inventory-confirmation" class="hidden bg-yellow-100 border-l-4 border-warning-bs p-4 rounded-md shadow-sm mt-3">
                        <p class="font-medium text-sm text-gray-800 mb-2">¿Estás seguro de que quieres borrar todo el inventario?</p>
                        <div class="flex justify-end space-x-2">
                            <button id="confirm-clear-btn" class="text-white bg-danger hover:bg-red-700 font-bold py-1 px-3 rounded-md text-xs">Sí, Borrar Todo</button>
                            <button id="cancel-clear-btn" class="text-gray-800 bg-gray-300 hover:bg-gray-400 font-bold py-1 px-3 rounded-md text-xs">Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
      
        <!-- Mensaje de Notificación (Usado en lugar de alert()) -->
        <div id="notification-box" class="fixed bottom-5 right-5 z-50 transition-transform transform translate-y-20 opacity-0 duration-300">
            <div class="bg-primary-bs text-white p-4 rounded-lg shadow-xl font-medium flex items-center space-x-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                <span id="notification-message"></span>
            </div>
        </div>

    </div>

    <script>
        // Declaración de variables globales
        let products = [];
        let exchangeRate = 0;
        let initialBalanceBs = 0;

        // Referencias a elementos del DOM
        const formEl = document.getElementById('product-form');
        const configFormEl = document.getElementById('config-form');
        const rateInput = document.getElementById('exchange-rate');
        const balanceInput = document.getElementById('initial-balance-bs');
        const nameInput = document.getElementById('product-name');
        const quantityInput = document.getElementById('product-quantity');
        const usdInput = document.getElementById('price-usd');
        const bsInput = document.getElementById('price-bs');
        const productIdEl = document.getElementById('product-id');
        const formTitleEl = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn'); // Nuevo botón
        const inventoryBody = document.getElementById('inventory-table-body');
        const totalUsdEl = document.getElementById('total-usd');
        const totalBsEl = document.getElementById('total-bs');
        const balanceSummaryEl = document.getElementById('balance-summary');
        const initialBalanceDisplayEl = document.getElementById('initial-balance-display');
        const remainingBsEl = document.getElementById('remaining-bs');
        const remainingUsdEl = document.getElementById('remaining-usd');
        const conversionInfoEl = document.getElementById('conversion-info');
        const emptyStateEl = document.getElementById('empty-state');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const clearInventoryBtn = document.getElementById('clear-inventory-btn');
        const clearConfirmationBox = document.getElementById('clear-inventory-confirmation');
        const confirmClearBtn = document.getElementById('confirm-clear-btn');
        const cancelClearBtn = document.getElementById('cancel-clear-btn');
        const notificationBox = document.getElementById('notification-box');
        const notificationMessage = document.getElementById('notification-message');
  

        // --- Funciones de Utilidad ---

        /** Muestra una notificación temporal */
        function showNotification(message, type = 'success') {
            const color = type === 'success' ? 'bg-primary-bs' : 'bg-danger';
            notificationBox.className = `fixed bottom-5 right-5 z-50 transition-transform transform translate-y-20 opacity-0 duration-300`;
            notificationBox.classList.remove('bg-primary-bs', 'bg-danger');
            notificationBox.classList.add(color);
            notificationMessage.textContent = message;

            // Mostrar
            setTimeout(() => {
                notificationBox.classList.remove('translate-y-20', 'opacity-0');
                notificationBox.classList.add('translate-y-0', 'opacity-100');
            }, 10);

            // Ocultar
            setTimeout(() => {
                notificationBox.classList.remove('translate-y-0', 'opacity-100');
                notificationBox.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        /** Formatea un número como moneda USD */
        function formatUsd(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }

        /** Formatea un número como moneda Bs. */
        function formatBs(amount) {
            return `Bs. ${new Intl.NumberFormat('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount)}`;
        }

        // --- Almacenamiento (localStorage) ---

        function saveProducts() {
            localStorage.setItem('inventoryProducts', JSON.stringify(products));
        }

        function loadProducts() {
            const data = localStorage.getItem('inventoryProducts');
            products = data ? JSON.parse(data) : [];
        }

        function saveFinancialConfig() {
            const config = {
                rate: exchangeRate,
                balance: initialBalanceBs
            };
            localStorage.setItem('inventoryConfig', JSON.stringify(config));
            showNotification('Configuración guardada.', 'success');
        }

        function loadFinancialConfig() {
            const data = localStorage.getItem('inventoryConfig');
            if (data) {
                const config = JSON.parse(data);
                exchangeRate = parseFloat(config.rate) || 0;
                initialBalanceBs = parseFloat(config.balance) || 0;

                rateInput.value = exchangeRate.toFixed(2);
                balanceInput.value = initialBalanceBs.toFixed(2);
            }
        }
  

        // --- Lógica del Formulario y Conversión ---

        /** Maneja la conversión de precios en tiempo real */
        function handlePriceInput(source) {
            let usdValue = parseFloat(usdInput.value) || 0;
            let bsValue = parseFloat(bsInput.value) || 0;
            const rate = exchangeRate;

            if (rate <= 0) {
                conversionInfoEl.textContent = 'Guarda una Tasa de Cambio primero.';
                return;
            }

            if (source === 'usd' && usdValue > 0) {
                // Si el usuario edita USD, calcula Bs.
                bsValue = usdValue * rate;
                bsInput.value = bsValue.toFixed(2);
                conversionInfoEl.textContent = `${formatUsd(usdValue)} x ${rate.toFixed(2)} = ${formatBs(bsValue)}`;
            } else if (source === 'bs' && bsValue > 0) {
                // Si el usuario edita Bs., calcula USD
                usdValue = bsValue / rate;
                usdInput.value = usdValue.toFixed(2);
                conversionInfoEl.textContent = `${formatBs(bsValue)} / ${rate.toFixed(2)} = ${formatUsd(usdValue)}`;
            } else {
                conversionInfoEl.textContent = 'Introduce un valor para la conversión.';
                // CORRECCIÓN: Si el valor es 0 o vacío, vaciamos los campos de precio
                // para que el usuario pueda escribir sin borrar el '0.00'.
                // Solo si el valor es 0, borramos el otro campo, si el valor es vacío,
                // significa que el usuario está borrando, y dejamos el otro campo en blanco.
                if (usdInput.value === '' || usdValue === 0) {
                    bsInput.value = '';
                }
                if (bsInput.value === '' || bsValue === 0) {
                    usdInput.value = '';
                }
            }
        }


        /** Agrega o actualiza un producto en la lista */
        function addOrUpdateProduct(e) {
            e.preventDefault();

            // Asegurar que la tasa de cambio esté establecida antes de agregar productos
            if (exchangeRate <= 0) {
                showNotification('Por favor, establece y guarda la Tasa de Cambio primero.', 'error');
                return;
            }

            const mode = formEl.dataset.mode;
            const id = productIdEl.value;
            const name = nameInput.value.trim();
            const quantity = parseInt(quantityInput.value);
            const priceUsd = parseFloat(usdInput.value);
            const priceBs = parseFloat(bsInput.value);

            if (name === "" || quantity <= 0 || priceUsd <= 0 || priceBs <= 0) {
                 showNotification('Revisa todos los campos: nombre, cantidad y precios deben ser válidos.', 'error');
                 return;
            }

            const newProduct = {
                id: mode === 'edit' ? id : crypto.randomUUID(), // Genera ID solo si es nuevo
                name,
                quantity,
                price: {
                    usd: priceUsd,
                    bs: priceBs
                }
            };

            if (mode === 'add') {
                products.push(newProduct);
                showNotification(`"${name}" agregado al inventario.`);
            } else {
                const index = products.findIndex(p => p.id === id);
                if (index !== -1) {
                    products[index] = newProduct;
                    showNotification(`"${name}" actualizado.`);
                    resetForm(); // Sale de modo edición después de actualizar
                }
            }

            saveProducts();
            renderInventory();
            formEl.reset();
            // Lógica corregida: No llamar a handlePriceInput('usd') después de resetear
            // ya que reset() hace lo que necesitamos (limpiar los campos de precio)
            // y la llamada anterior a handlePriceInput('usd') los forzaba a '0.00'.
            conversionInfoEl.textContent = ''; // Limpia el texto de info de conversión
        }
  
        /** Función para restablecer el formulario al modo "Agregar" */
        function resetForm() {
            formTitleEl.textContent = 'Agregar Nuevo Producto';
            submitBtn.textContent = 'Agregar Producto';
            submitBtn.classList.remove('bg-edit-color');
            submitBtn.classList.add('bg-primary-bs');
            formEl.dataset.mode = 'add';
            productIdEl.value = '';
            formEl.reset();
            cancelEditBtn.classList.add('hidden');
            conversionInfoEl.textContent = ''; // Asegurar que el mensaje de info se borre
            usdInput.value = ''; // Resetear manualmente a vacío para mejor UX
            bsInput.value = ''; // Resetear manualmente a vacío para mejor UX
        }


        /** Función CRÍTICA para el modo edición */
        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Producto no encontrado para editar.', 'error');
                return;
            }

            // 1. Establecer el modo edición en el formulario
            formTitleEl.textContent = 'Editar Producto';
            submitBtn.textContent = 'Actualizar Producto';
            submitBtn.classList.remove('bg-primary-bs');
            submitBtn.classList.add('bg-edit-color');
            formEl.dataset.mode = 'edit';
            cancelEditBtn.classList.remove('hidden'); // Muestra el botón de cancelar
            formEl.scrollIntoView({ behavior: 'smooth' }); // Desplazarse al formulario

            // 2. Llenar el formulario con los datos del producto
            nameInput.value = product.name;
            quantityInput.value = product.quantity;
            
            // Llenar campos de precio con los valores a dos decimales
            usdInput.value = product.price.usd.toFixed(2);
            bsInput.value = product.price.bs.toFixed(2);
            productIdEl.value = product.id;

            // 3. Recalcular la conversión para asegurar que ambos campos estén sincronizados
            // Esto asegura que el texto de info de conversión se muestre correctamente al editar.
            handlePriceInput('usd');
        }

        /** Elimina un producto de la lista */
        function deleteProduct(productId) {
            const productIndex = products.findIndex(p => p.id === productId);
            if (productIndex !== -1) {
                const productName = products[productIndex].name;
                products.splice(productIndex, 1);
                saveProducts();
                renderInventory();
                showNotification(`"${productName}" eliminado.`, 'danger');
            }
        }
  

        // --- Renderizado y Cálculos ---

        /** Calcula el valor total del inventario */
        function calculateTotal() {
            const totals = products.reduce((acc, product) => {
                const itemTotalUsd = product.price.usd * product.quantity;
                const itemTotalBs = product.price.bs * product.quantity;
                acc.totalUsd += itemTotalUsd;
                acc.totalBs += itemTotalBs;
                return acc;
            }, { totalUsd: 0, totalBs: 0 });

            // Calcular saldo restante
            let remainingBs = 0;
            let remainingUsd = 0;
            const isBalanceSet = initialBalanceBs > 0;

            if (isBalanceSet) {
                remainingBs = initialBalanceBs - totals.totalBs;
                remainingUsd = exchangeRate > 0 ? remainingBs / exchangeRate : 0;
            }

            return {
                ...totals,
                remainingBs,
                remainingUsd,
                isBalanceSet
            };
        }

        /** Renderiza la tabla de inventario y el resumen */
        function renderInventory() {
            inventoryBody.innerHTML = ''; // Limpiar tabla
            const { totalUsd, totalBs, remainingBs, remainingUsd, isBalanceSet } = calculateTotal();

            // 1. Actualizar tabla
            if (products.length === 0) {
                emptyStateEl.classList.remove('hidden');
            } else {
                emptyStateEl.classList.add('hidden');
                products.forEach(product => {
                    const totalUsdItem = product.price.usd * product.quantity;
                    const totalBsItem = product.price.bs * product.quantity;

                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50 transition-colors';
                    tr.innerHTML = `
                        <td class="p-3 font-medium text-gray-900">${product.name}</td>
                        <td class="p-3 text-left font-mono">${product.quantity}</td>
                        <td class="p-3 text-right font-mono text-secondary-usd">${formatUsd(product.price.usd)}</td>
                        <td class="p-3 text-right font-mono text-primary-bs">${formatBs(product.price.bs)}</td>
                        <td class="p-3 text-right font-bold text-gray-800">${formatUsd(totalUsdItem)}</td>
                        <td class="p-3 text-right font-bold text-gray-800">${formatBs(totalBsItem)}</td>
                    `;

                    // Botones de acción
                    const actionsTd = document.createElement('td');
                    actionsTd.className = 'p-3 text-right space-x-2 whitespace-nowrap';

                    // Botón de Edición
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Editar';
                    editBtn.className = 'text-edit-color hover:text-orange-700 font-semibold text-sm transition-colors mr-2';
                    editBtn.onclick = () => editProduct(product.id);

                    // Botón de Eliminación
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Eliminar';
                    deleteBtn.className = 'text-red-600 hover:text-red-800 font-semibold text-sm transition-colors';
                    deleteBtn.onclick = () => deleteProduct(product.id);

                    actionsTd.appendChild(editBtn);
                    actionsTd.appendChild(deleteBtn);
                    tr.appendChild(actionsTd);
                    inventoryBody.appendChild(tr);
                });
            }
          
            // 2. Actualizar resumen
            totalUsdEl.textContent = formatUsd(totalUsd);
            totalBsEl.textContent = formatBs(totalBs);

            // 3. Actualizar sección de saldo (si aplica)
            if (isBalanceSet) {
                balanceSummaryEl.classList.remove('hidden');
                initialBalanceDisplayEl.textContent = formatBs(initialBalanceBs);

                const remainingBsText = formatBs(remainingBs);
                const remainingUsdText = formatUsd(remainingUsd);

                remainingBsEl.textContent = remainingBsText;
                remainingUsdEl.textContent = remainingUsdText;

                // Color para saldo (verde si positivo, rojo si negativo)
                if (remainingBs >= 0) {
                    remainingBsEl.classList.remove('text-danger');
                    remainingBsEl.classList.add('text-success');
                } else {
                    remainingBsEl.classList.remove('text-success');
                    remainingBsEl.classList.add('text-danger');
                }
            } else {
                balanceSummaryEl.classList.add('hidden');
            }
        }


        // --- Exportar a PDF ---

        /** Genera y descarga el reporte en formato PDF */
        function exportInventoryToPDF() {
            // Asegurarse de que window.jspdf.jsPDF esté disponible
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                showNotification('Error: Librerías PDF no cargadas correctamente.', 'error');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            let currentY = 10;
            const margin = 10;

            // Título
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(30);
            doc.text('Reporte de Inventario', margin, currentY);
            currentY += 8;

            // Subtítulo y Fecha
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100);
            doc.text(`Fecha del Reporte: ${new Date().toLocaleDateString('es-VE')}`, margin, currentY);
            doc.text(`Tasa de Cambio (USD/Bs.): ${exchangeRate.toFixed(2)}`, pageWidth - margin, currentY, { align: 'right' });
            currentY += 8;
          
            // Datos de la tabla
            const tableData = products.map(product => {
                const totalUsdItem = product.price.usd * product.quantity;
                const totalBsItem = product.price.bs * product.quantity;
                return [
                    product.name,
                    product.quantity,
                    formatUsd(product.price.usd),
                    formatBs(product.price.bs),
                    formatUsd(totalUsdItem),
                    formatBs(totalBsItem),
                ];
            });

            // Configuración de autoTable
            doc.autoTable({
                head: [['Producto', 'Cantidad', 'USD Unitario', 'Bs. Unitario', 'Total USD', 'Total Bs.']],
                body: tableData,
                startY: currentY,
                theme: 'striped',
                headStyles: { fillColor: [74, 124, 89], textColor: 255, fontStyle: 'bold' }, // Color primary-bs
                columnStyles: {
                    1: { halign: 'center' }, // Cantidad
                    2: { halign: 'right' }, // USD Unitario
                    3: { halign: 'right' }, // Bs. Unitario
                    4: { halign: 'right', fontStyle: 'bold' }, // Total USD
                    5: { halign: 'right', fontStyle: 'bold' }, // Total Bs.
                },
                didDrawPage: function(data) {
                    // Pie de página con el número de página
                    doc.setFontSize(8);
                    doc.text('Página ' + doc.internal.getNumberOfPages(), pageWidth - margin, doc.internal.pageSize.getHeight() - margin, { align: 'right' });
                }
            });
          
            // Posición final de la tabla
            currentY = doc.autoTable.previous.finalY + 10;

            // Resumen de Totales y Saldo
            const { totalUsd, totalBs, remainingBs, remainingUsd, isBalanceSet } = calculateTotal();
            const totalUsdText = formatUsd(totalUsd);
            const totalBsText = formatBs(totalBs);
            const remainingBsText = formatBs(remainingBs);
            const remainingUsdText = formatUsd(remainingUsd);

            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(50);

            // Función de ayuda para dibujar líneas de resumen
            let boxY = currentY;
            const boxX = pageWidth - margin - 70; // 70mm de ancho para la caja
            const boxWidth = 70;

            const drawSummaryLine = (label, value, isNegative = false) => {
                doc.setFont('helvetica', 'normal');
                doc.text(label, boxX, boxY);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(isNegative ? 220 : 50); // Rojo si es negativo
                doc.text(value, boxX + boxWidth, boxY, { align: 'right' });
                doc.setTextColor(50); // Resetear color
                boxY += 5;
            };

            // Dibujar recuadro de resumen
            const boxHeight = isBalanceSet ? 28 : 13;
            doc.setFillColor(240, 240, 240); // Fondo gris claro
            doc.rect(boxX - 5, currentY - 5, boxWidth + 10, boxHeight, 'F'); // Dibujar fondo

            // Volver a dibujar los textos dentro del recuadro
            doc.setTextColor(50); // Color de texto oscuro

            boxY = currentY;
            drawSummaryLine("Total General (USD):", totalUsdText);
            drawSummaryLine("Total General (Bs.):", totalBsText);

            if (isBalanceSet) {
                doc.setDrawColor(200);
                doc.line(boxX - 5, boxY - 2, boxX + boxWidth + 5, boxY - 2); // Línea divisoria
                drawSummaryLine("Saldo Inicial (Bs.):", formatBs(initialBalanceBs));
                drawSummaryLine("Saldo Restante (Bs.):", remainingBsText, remainingBs < 0);
                drawSummaryLine("Saldo Restante (USD):", remainingUsdText, remainingBs < 0);
            }


            // Guardar el PDF
            doc.save(`Inventario_Reporte_${new Date().toISOString().slice(0, 10)}.pdf`);
        }


        // --- Inicialización y Event Listeners ---

        // 1. Manejador de configuración financiera
        configFormEl.addEventListener('submit', function(e) {
            e.preventDefault();
            exchangeRate = parseFloat(rateInput.value) || 0;
            initialBalanceBs = parseFloat(balanceInput.value) || 0;
            saveFinancialConfig();
            renderInventory(); // Volver a renderizar para actualizar resumen con nueva tasa/saldo
        });
  
        // 2. Manejador de envío de formulario de productos
        formEl.addEventListener('submit', addOrUpdateProduct);

        // 3. Manejadores para limpieza de inventario
        clearInventoryBtn.addEventListener('click', () => {
            clearConfirmationBox.classList.remove('hidden');
        });

        cancelClearBtn.addEventListener('click', () => {
            clearConfirmationBox.classList.add('hidden');
        });

        confirmClearBtn.addEventListener('click', () => {
            products = [];
            saveProducts();
            renderInventory();
            clearConfirmationBox.classList.add('hidden');
            resetForm();
            showNotification('Inventario borrado completamente.', 'danger');
        });

        // 4. Manejador de exportación
        exportPdfBtn.addEventListener('click', exportInventoryToPDF);

        // 5. Manejador de cancelación de edición (FIX UX)
        cancelEditBtn.addEventListener('click', resetForm);

        // 6. Inicializar la aplicación al cargar la página
        window.onload = function() {
            loadFinancialConfig();
            loadProducts();
            
            // Configurar listeners de entrada de precios para manejar la conversión en tiempo real
            // Lógica corregida: handlePriceInput ahora maneja mejor los valores vacíos o cero.
            usdInput.addEventListener('input', () => handlePriceInput('usd'));
            bsInput.addEventListener('input', () => handlePriceInput('bs'));
            
            renderInventory(); // Inicializa la vista con los datos guardados
        };
    </script>
</body>
</html>
