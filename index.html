<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Offline (Bs. / USD)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de Tailwind para usar el color primario y la fuente Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-bs': '#4a7c59', // Tono de verde amigable (Verde)
                        'secondary-usd': '#003865', // Azul oscuro (USD)
                        'warning-bs': '#ffc107', // Amarillo para advertencias/saldo (YA NO USAMOS ESTE PARA SALDO)
                        'edit-color': '#f97316', // Naranja para el modo edición
                        'danger': '#dc2626', // Rojo
                        'success': '#16a34a', // Verde de éxito
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Carga de la fuente Inter de Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Carga de las librerías jspdf y jspdf-autotable para generar el PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Carga de Phosphor Icons para iconos -->
    <script src="https://unpkg.com/phosphor-icons"></script>
    <!-- Código para asegurar que window.jsPDF esté disponible globalmente (necesario por la forma en que carga jspdf) -->
    <script>window.jsPDF = window.jspdf.jsPDF;</script>
    <style>
        /* Estilos generales para asegurar una buena visualización en dispositivos móviles */
        .container {
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
        }
        @media (min-width: 640px) {
            .container {
                max-width: 600px; /* Ancho máximo para desktop/tablet */
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8 font-sans">

    <div class="container mx-auto">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-800 flex items-center justify-center">
                <i class="ph-wallet-fill text-primary-bs mr-3 text-3xl"></i>
                Control de Inventario <span class="text-secondary-usd ml-2">(Bs. / USD)</span>
            </h1>
            <p class="text-gray-500 mt-2">Gestiona tus gastos en ambas divisas.</p>
        </header>

        <!-- Sección de Configuración y Resumen Financiero -->
        <div class="grid grid-cols-1 gap-6 mb-8">
            
            <!-- Sección de Configuración -->
            <div class="p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-secondary-usd mb-4 border-b pb-2">Configuración Financiera</h2>

                <!-- Tasa de Cambio -->
                <div class="mb-4">
                    <label for="exchange_rate" class="block text-sm font-medium text-gray-700">Tasa de Cambio (1 USD a Bs.)</label>
                    <input type="number" id="exchange_rate" name="exchange_rate" class="w-full mt-1 p-2 border rounded-lg focus:ring-secondary-usd focus:border-secondary-usd text-lg" value="0.00" min="0.01" step="0.01">
                </div>

                <!-- Saldo Inicial en Bolívares -->
                <div class="mb-4">
                    <label for="initial_bs_balance" class="block text-sm font-medium text-gray-700">Saldo Inicial Total en Bolívares (Bs.)</label>
                    <input type="number" id="initial_bs_balance" name="initial_bs_balance" class="w-full mt-1 p-2 border rounded-lg focus:ring-primary-bs focus:border-primary-bs text-xl font-bold" value="0" min="0" step="0.01">
                </div>

                <!-- Saldo Inicial USD -->
                <div class="mb-4">
                    <label for="initial_usd_balance" class="block text-sm font-medium text-gray-700">Saldo Inicial en Dólares (USD)</label>
                    <input type="number" id="initial_usd_balance" name="initial_usd_balance" class="w-full mt-1 p-2 border rounded-lg focus:ring-secondary-usd focus:border-secondary-usd text-lg" value="0.00" min="0" step="0.01">
                </div>

                <!-- Saldo Equivalente (Previsualización de la suma total convertida) -->
                <div class="flex justify-between items-center mb-4 p-2 bg-gray-100 rounded-lg border">
                    <!-- CAMBIO SOLICITADO: QUITAR LA PALABRA COMBINADO -->
                    <span class="text-gray-600 font-medium text-sm">PRESUPUESTO TOTAL:</span> 
                    <div class="text-right">
                        <!-- Esto ahora muestra el total combinado de ambas monedas -->
                        <span id="equivalent_usd" class="font-bold text-sm text-secondary-usd block">0.00 USD</span>
                        <span id="equivalent_bs" class="font-bold text-sm text-primary-bs block">0.00 Bs.</span>
                    </div>
                </div>

                <!-- Botón de Guardar Configuración -->
                <button id="save_config_btn" class="w-full bg-primary-bs text-white py-2 rounded-lg font-semibold hover:bg-opacity-90 transition duration-150 shadow-md flex items-center justify-center">
                    <i class="ph-floppy-disk-fill mr-2"></i>
                    Guardar Configuración
                </button>
            </div>

            <!-- Sección de Resumen Financiero -->
            <div id="financial-summary" class="p-6 bg-white rounded-xl shadow-lg">
                <p class="font-bold text-xl mb-3 text-secondary-usd border-b pb-2">Control de Saldo</p>
                
                <!-- Muestra el Total Gastado -->
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-600 font-medium">Total Gastado (Bs.):</span>
                    <span id="total-spent-bs" class="font-semibold text-lg text-danger">0.00 Bs.</span>
                </div>
                <div class="flex justify-between items-center mb-3">
                    <span class="text-gray-600 font-medium">Total Gastado (USD):</span>
                    <span id="total-spent-usd" class="font-semibold text-lg text-secondary-usd">0.00 USD</span>
                </div>

                <!-- Muestra el Saldo Restante en Bs. (Ahora incluye el equivalente de USD en el cálculo) -->
                <div class="flex justify-between items-center pt-3 border-t border-gray-300 mb-4">
                    <span class="text-gray-800 font-extrabold">SALDO RESTANTE (Bs.):</span>
                    <span id="remaining-bs-balance" class="font-extrabold text-3xl text-success">0.00 Bs.</span>
                </div>
                
                <!-- Muestra el Saldo Restante en USD (Ahora incluye el equivalente de Bs. en el cálculo) -->
                <div class="flex justify-between items-center pt-2 border-t border-gray-100">
                    <span class="text-gray-800 font-extrabold">SALDO RESTANTE (USD):</span>
                    <span id="remaining-usd-balance" class="font-extrabold text-2xl text-secondary-usd">0.00 USD</span>
                </div>

            </div>

        </div>

        <!-- Sección de Agregar/Editar Producto -->
        <div class="p-6 bg-white rounded-xl shadow-lg mb-8" id="product-form-card">
            <h2 class="text-xl font-bold text-edit-color mb-4 border-b pb-2" id="form-title">Agregar Nuevo Producto</h2>
            
            <input type="hidden" id="product_id">

            <div class="mb-4">
                <label for="product_name" class="block text-sm font-medium text-gray-700">Nombre del Producto</label>
                <input type="text" id="product_name" name="product_name" class="w-full mt-1 p-2 border rounded-lg focus:ring-primary-bs focus:border-primary-bs" placeholder="Ej: Shampoo Pantene" required>
            </div>

            <!-- CAMPO DE CANTIDAD -->
            <div class="mb-4">
                <label for="quantity" class="block text-sm font-medium text-gray-700">Cantidad</label>
                <input type="number" id="quantity" name="quantity" class="w-full mt-1 p-2 border rounded-lg focus:ring-primary-bs focus:border-primary-bs text-lg font-semibold" value="1" min="1" step="1" required>
            </div>

            <!-- Inputs de Costo Unitario -->
            <div class="flex space-x-4 mb-4">
                <div class="flex-1">
                    <label for="cost_usd" class="block text-sm font-medium text-gray-700">Costo Unitario (USD)</label>
                    <input type="number" id="cost_usd" name="cost_usd" class="w-full mt-1 p-2 border rounded-lg focus:ring-secondary-usd focus:border-secondary-usd text-lg" value="0.00" min="0.00" step="0.01">
                </div>
                <div class="flex-1">
                    <label for="cost_bs" class="block text-sm font-medium text-gray-700">Costo Unitario (Bs.)</label>
                    <input type="number" id="cost_bs" name="cost_bs" class="w-full mt-1 p-2 border rounded-lg focus:ring-primary-bs focus:border-primary-bs text-lg" value="0.00" min="0.00" step="0.01"> 
                </div>
            </div>
            <p class="text-xs text-gray-500 mb-4">Ingrese el costo unitario. Si ingresa la tasa de cambio, el otro campo se actualizará automáticamente.</p>

            <div class="flex space-x-4">
                <button id="add_product_btn" class="flex-1 bg-primary-bs text-white py-2 rounded-lg font-semibold hover:bg-opacity-90 transition duration-150 shadow-md">
                    <i class="ph-plus-circle-fill mr-1"></i>
                    Agregar Producto
                </button>
                <button id="update_product_btn" class="flex-1 bg-edit-color text-white py-2 rounded-lg font-semibold hover:bg-opacity-90 transition duration-150 shadow-md hidden">
                    <i class="ph-pencil-fill mr-1"></i>
                    Actualizar Producto
                </button>
                <button id="cancel_edit_btn" class="bg-gray-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-gray-600 transition duration-150 shadow-md hidden">
                    <i class="ph-x-circle-fill mr-1"></i>
                    Cancelar
                </button>
            </div>
        </div>

        <!-- Sección de Inventario -->
        <div class="p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Inventario de Productos (<span id="product-count">0</span>)</h2>
            
            <!-- Botones de Acción -->
            <div class="flex justify-between items-center mb-4 space-x-2">
                <button id="export_pdf_btn" class="flex-1 bg-secondary-usd text-white py-2 rounded-lg font-semibold hover:bg-opacity-90 transition duration-150 shadow-md text-sm">
                    <i class="ph-file-pdf-fill mr-1"></i> Exportar a PDF
                </button>
                <button id="clear_inventory_btn" class="flex-1 bg-danger text-white py-2 rounded-lg font-semibold hover:bg-opacity-90 transition duration-150 shadow-md text-sm">
                    <i class="ph-trash-fill mr-1"></i> Borrar Inventario
                </button>
            </div>

            <!-- Lista de Productos -->
            <div id="inventory_list" class="space-y-3">
                <!-- Los productos se insertarán aquí -->
            </div>

            <!-- Mensaje de Inventario Vacío -->
            <div id="empty_message" class="text-center p-6 text-gray-500 hidden">
                <i class="ph-archive-box-fill text-5xl mb-2"></i>
                <p>El inventario está vacío. Agrega tu primer producto arriba.</p>
            </div>
        </div>

        <!-- Modal de Confirmación de Borrado -->
        <div id="clear_confirmation_box" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                <h3 class="text-lg font-bold text-danger mb-4">Confirmar Borrado</h3>
                <p class="text-gray-700 mb-6">¿Estás absolutamente seguro de que deseas borrar <span class="font-extrabold">TODO</span> el inventario? Esta acción es irreversible.</p>
                <div class="flex justify-end space-x-4">
                    <button id="cancel_clear_btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-150">Cancelar</button>
                    <button id="confirm_clear_btn" class="px-4 py-2 bg-danger text-white rounded-lg hover:bg-red-600 transition duration-150">Sí, Borrar Todo</button>
                </div>
            </div>
        </div>

        <!-- Área de Notificaciones (para mensajes tipo toast) -->
        <div id="notification_area" class="fixed bottom-4 right-4 space-y-2 z-50">
            <!-- Las notificaciones se insertarán aquí -->
        </div>

    </div>

    <script>
        // --- Constantes y Variables Globales ---
        const STORAGE_KEY_PRODUCTS = 'inventory_products';
        const STORAGE_KEY_CONFIG = 'inventory_financial_config';

        let products = [];
        let financialConfig = {
            exchangeRate: 0,
            initialUsdBalance: 0,
            initialBsBalance: 0, 
        };
        let currentEditingId = null;

        // --- Referencias a Elementos del DOM ---
        const inventoryList = document.getElementById('inventory_list');
        const productNameInput = document.getElementById('product_name');
        const quantityInput = document.getElementById('quantity');
        const costUsdInput = document.getElementById('cost_usd'); 
        const costBsInput = document.getElementById('cost_bs');
        const addProductBtn = document.getElementById('add_product_btn');
        const updateProductBtn = document.getElementById('update_product_btn');
        const cancelEditBtn = document.getElementById('cancel_edit_btn');
        const formTitle = document.getElementById('form-title');
        const productCountDisplay = document.getElementById('product-count');
        const emptyMessage = document.getElementById('empty_message');
        const clearInventoryBtn = document.getElementById('clear_inventory_btn');
        const exportPdfBtn = document.getElementById('export_pdf_btn');
        const clearConfirmationBox = document.getElementById('clear_confirmation_box');
        const cancelClearBtn = document.getElementById('cancel_clear_btn');
        const confirmClearBtn = document.getElementById('confirm_clear_btn');
        
        // Elementos de Configuración
        const rateInput = document.getElementById('exchange_rate');
        const initialUsdInput = document.getElementById('initial_usd_balance');
        const initialBsInput = document.getElementById('initial_bs_balance');
        const saveConfigBtn = document.getElementById('save_config_btn');
        
        // Elementos de Resumen
        const totalSpentBsDisplay = document.getElementById('total-spent-bs');
        const totalSpentUsdDisplay = document.getElementById('total-spent-usd');
        const remainingBsDisplay = document.getElementById('remaining-bs-balance');
        const remainingUsdDisplay = document.getElementById('remaining-usd-balance');
        
        // Elementos de Saldo Equivalente (Previsualización de totales)
        const equivalentUsdDisplay = document.getElementById('equivalent_usd');
        const equivalentBsDisplay = document.getElementById('equivalent_bs');


        // --- Funciones de Utilidad ---

        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function showNotification(message, type = 'success') {
            const notificationArea = document.getElementById('notification_area');
            const colorClass = {
                'success': 'bg-success',
                'danger': 'bg-danger',
                'warning': 'bg-warning-bs',
                'info': 'bg-secondary-usd',
            }[type] || 'bg-gray-800';

            const notification = document.createElement('div');
            notification.className = `${colorClass} text-white p-3 rounded-lg shadow-xl transition-all duration-300 transform translate-x-0 opacity-100 max-w-xs`;
            notification.textContent = message;

            notificationArea.appendChild(notification);

            // Ocultar y remover después de 3 segundos
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // --- Manejo de Datos (localStorage) ---

        function loadProducts() {
            const storedProducts = localStorage.getItem(STORAGE_KEY_PRODUCTS);
            if (storedProducts) {
                try {
                    products = JSON.parse(storedProducts);
                } catch (e) {
                    console.error("Error loading products:", e);
                    products = [];
                }
            }
        }

        function saveProducts() {
            localStorage.setItem(STORAGE_KEY_PRODUCTS, JSON.stringify(products));
            renderFinancialSummary();
        }

        function loadFinancialConfig() {
            const config = localStorage.getItem(STORAGE_KEY_CONFIG);
            if (config) {
                try {
                    const parsedConfig = JSON.parse(config);
                    // Asegurar que todos los valores sean números, usando 0 como fallback
                    financialConfig.exchangeRate = parseFloat(parsedConfig.exchangeRate) || 0;
                    financialConfig.initialUsdBalance = parseFloat(parsedConfig.initialUsdBalance) || 0;
                    financialConfig.initialBsBalance = parseFloat(parsedConfig.initialBsBalance) || 0; 
                } catch (e) {
                    console.error("Error loading financial config:", e);
                }
            }
        }

        function saveFinancialConfig() {
            // Lee los valores de los inputs y los guarda
            financialConfig.exchangeRate = parseFloat(rateInput.value) || 0;
            financialConfig.initialUsdBalance = parseFloat(initialUsdInput.value) || 0;
            financialConfig.initialBsBalance = parseFloat(initialBsInput.value) || 0; 

            localStorage.setItem(STORAGE_KEY_CONFIG, JSON.stringify(financialConfig));
            renderFinancialSummary();
            showNotification('Configuración financiera guardada.', 'info');
        }

        // --- Lógica Financiera ---

        // Función para calcular el total gastado en Bs.
        function calculateBsTotal() {
            // Suma el costo total en Bs. de todos los productos
            return products.reduce((sum, product) => sum + (parseFloat(product.costBs) || 0) * (parseInt(product.quantity) || 0), 0);
        }

        // Función para calcular el total gastado en USD.
        function calculateUsdTotal() {
            // Suma el costo total en USD de todos los productos
            return products.reduce((sum, product) => sum + (parseFloat(product.costUsd) || 0) * (parseInt(product.quantity) || 0), 0);
        }

        // Función para calcular y mostrar el saldo equivalente (Previsualización)
        function updateEquivalentBalance() {
            const rate = parseFloat(rateInput.value) || 0;
            const initialUsd = parseFloat(initialUsdInput.value) || 0;
            const initialBs = parseFloat(initialBsInput.value) || 0;
            
            // Lógica para Presupuesto Total en Bolívares (Bs.)
            let totalBsBudget = initialBs;
            if (rate > 0) {
                totalBsBudget += initialUsd * rate;
            }
            // CAMBIO SOLICITADO: QUITAR LA PALABRA COMBINADO EN LA ETIQUETA
            equivalentBsDisplay.textContent = `${totalBsBudget.toFixed(2)} Bs.`; 

            // Lógica para Presupuesto Total en Dólares (USD)
            let totalUsdBudget = initialUsd;
            if (rate > 0) {
                totalUsdBudget += initialBs / rate;
            }
            // CAMBIO SOLICITADO: QUITAR LA PALABRA COMBINADO EN LA ETIQUETA
            equivalentUsdDisplay.textContent = `${totalUsdBudget.toFixed(2)} USD`;
        }


        // Renderiza el resumen financiero 
        function renderFinancialSummary() {
            const totalBsSpent = calculateBsTotal();
            const totalUsdSpent = calculateUsdTotal();
            const rate = financialConfig.exchangeRate;
            
            // 1. Sincroniza los inputs de configuración con los valores guardados
            rateInput.value = financialConfig.exchangeRate.toFixed(2);
            initialUsdInput.value = financialConfig.initialUsdBalance.toFixed(2);
            initialBsInput.value = financialConfig.initialBsBalance.toFixed(2); 

            // ** 1.5. CALCULA EL PRESUPUESTO TOTAL (BASE PARA EL SALDO RESTANTE) **
            let totalBsBudget = financialConfig.initialBsBalance;
            let totalUsdBudget = financialConfig.initialUsdBalance;

            if (rate > 0) {
                // Presupuesto Total Bs = Saldo Inicial Bs + (Saldo Inicial USD * Tasa)
                totalBsBudget += (financialConfig.initialUsdBalance * rate);
                
                // Presupuesto Total USD = Saldo Inicial USD + (Saldo Inicial Bs / Tasa)
                totalUsdBudget += (financialConfig.initialBsBalance / rate);
            }
            
            // Actualiza la previsualización del total (en el formulario de config)
            updateEquivalentBalance();

            // 2. Resumen Bs. (Cálculo y Display)
            // Saldo Restante Bs = Presupuesto Total (Bs) - Total Gastado Bs
            const remainingBsBalance = totalBsBudget - totalBsSpent; 
            
            totalSpentBsDisplay.textContent = `${totalBsSpent.toFixed(2)} Bs.`;
            remainingBsDisplay.textContent = `${remainingBsBalance.toFixed(2)} Bs.`;

            // CAMBIO SOLICITADO: Lógica de color solo verde o rojo (>=0 verde, <0 rojo)
            remainingBsDisplay.classList.remove('text-success', 'text-danger', 'text-secondary-usd', 'text-primary-bs', 'text-warning-bs');
            if (remainingBsBalance < 0) {
                remainingBsDisplay.classList.add('text-danger'); 
            } else {
                remainingBsDisplay.classList.add('text-success'); 
            }

            // 3. Resumen USD (Cálculo y Display)
            // Saldo Restante USD = Presupuesto Total (USD) - Total Gastado USD
            const remainingUsdBalance = totalUsdBudget - totalUsdSpent;
            
            totalSpentUsdDisplay.textContent = `${totalUsdSpent.toFixed(2)} USD`;
            remainingUsdDisplay.textContent = `${remainingUsdBalance.toFixed(2)} USD`;
            
            // CAMBIO SOLICITADO: Lógica de color solo verde o rojo (>=0 verde, <0 rojo)
            remainingUsdDisplay.classList.remove('text-secondary-usd', 'text-success', 'text-danger', 'text-primary-bs', 'text-warning-bs');
            if (remainingUsdBalance < 0) {
                remainingUsdDisplay.classList.add('text-danger'); 
            } else {
                // Usamos text-secondary-usd o text-success para el positivo, el éxito es más claro
                remainingUsdDisplay.classList.add('text-success'); 
            }
        }
        
        // Lógica de conversión en tiempo real
        function handlePriceInput(source) {
            const rate = financialConfig.exchangeRate;
            let usdValue = parseFloat(costUsdInput.value) || 0;
            let bsValue = parseFloat(costBsInput.value) || 0;

            if (rate > 0) {
                // Si la fuente es USD, calcula BS.
                if (source === 'usd') {
                    bsValue = usdValue * rate;
                    costBsInput.value = bsValue.toFixed(2);
                } 
                // Si la fuente es BS., calcula USD.
                else if (source === 'bs') {
                    usdValue = bsValue / rate;
                    costUsdInput.value = usdValue.toFixed(2);
                }
            }
        }

        // --- Lógica del Inventario (CRUD) ---

        function renderInventory() {
            inventoryList.innerHTML = '';
            productCountDisplay.textContent = products.length;

            if (products.length === 0) {
                emptyMessage.classList.remove('hidden');
            } else {
                emptyMessage.classList.add('hidden');
                
                products.sort((a, b) => a.name.localeCompare(b.name));

                products.forEach(product => {
                    // Calcular costos totales para mostrar
                    const totalCostUsd = (parseFloat(product.costUsd) || 0) * (parseInt(product.quantity) || 0);
                    const totalCostBs = (parseFloat(product.costBs) || 0) * (parseInt(product.quantity) || 0);

                    const productElement = document.createElement('div');
                    productElement.className = 'flex items-center justify-between p-4 bg-gray-50 border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition duration-150';
                    productElement.innerHTML = `
                        <div class="flex-1 min-w-0 pr-4">
                            <p class="font-semibold text-gray-800 truncate">${product.name}</p>
                            <p class="text-xs text-gray-500">Cantidad: <span class="font-bold text-gray-700">${product.quantity}</span> | Costo Unitario (USD): ${product.costUsd.toFixed(2)} | Costo Unitario (Bs.): ${product.costBs.toFixed(2)}</p>
                            
                            <!-- MOSTRAR AMBOS TOTALES CLARAMENTE -->
                            <div class="flex flex-col sm:flex-row sm:space-x-4 mt-1">
                                <p class="text-sm font-bold text-secondary-usd">Total: ${totalCostUsd.toFixed(2)} USD</p>
                                <p class="text-sm font-bold text-primary-bs">Total: ${totalCostBs.toFixed(2)} Bs.</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editProduct('${product.id}')" class="text-edit-color p-2 rounded-full hover:bg-edit-color hover:text-white transition duration-150" aria-label="Editar">
                                <i class="ph-pencil-fill text-xl"></i>
                            </button>
                            <button onclick="deleteProduct('${product.id}')" class="text-danger p-2 rounded-full hover:bg-danger hover:text-white transition duration-150" aria-label="Eliminar">
                                <i class="ph-trash-fill text-xl"></i>
                            </button>
                        </div>
                    `;
                    inventoryList.appendChild(productElement);
                });
            }
            renderFinancialSummary(); 
        }

        // Añadir nuevo producto 
        function addNewProduct() {
            const name = productNameInput.value.trim();
            const quantity = parseInt(quantityInput.value) || 0; 
            let costUsd = parseFloat(costUsdInput.value) || 0;
            let costBs = parseFloat(costBsInput.value) || 0;

            if (!name) {
                showNotification('El nombre del producto es obligatorio.', 'warning');
                return;
            }
            if (quantity <= 0) {
                 showNotification('La cantidad debe ser mayor a cero.', 'warning');
                 return;
            }

            // Validación de costos: al menos uno debe ser positivo
            if (costUsd <= 0 && costBs <= 0) {
                showNotification('Debe ingresar un costo unitario válido en Bs. o USD.', 'warning');
                return;
            }
            
            // Lógica de Conversión Final (Asegurar que ambos campos tienen valor si la tasa está disponible)
            if (financialConfig.exchangeRate > 0) {
                // Si el USD fue el único ingresado, recalcular BS para guardar la conversión más reciente
                if (costBs === 0 && costUsd > 0) {
                    costBs = costUsd * financialConfig.exchangeRate;
                } 
                // Si el BS fue el único ingresado, recalcular USD para guardar la conversión más reciente
                else if (costUsd === 0 && costBs > 0) {
                    costUsd = costBs / financialConfig.exchangeRate;
                }
            }

            const newProduct = {
                id: generateUniqueId(),
                name: name,
                quantity: quantity, 
                costUsd: costUsd,
                costBs: costBs,
            };

            products.push(newProduct);
            saveProducts();
            renderInventory();
            resetForm();
            showNotification(`Producto "${name}" (x${quantity}) agregado.`, 'success');
        }

        // Cargar producto para edición 
        window.editProduct = function(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                currentEditingId = id;
                productNameInput.value = product.name;
                quantityInput.value = product.quantity; 
                // Asegurar 2 decimales en los inputs de costo
                costUsdInput.value = product.costUsd.toFixed(2);
                costBsInput.value = product.costBs.toFixed(2);
                
                // Mostrar botones de edición
                addProductBtn.classList.add('hidden');
                updateProductBtn.classList.remove('hidden');
                cancelEditBtn.classList.remove('hidden');
                formTitle.textContent = 'Editar Producto';
                document.getElementById('product-form-card').classList.add('border-4', 'border-edit-color', 'shadow-2xl');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Actualizar producto 
        function updateProduct() {
            const id = currentEditingId;
            const name = productNameInput.value.trim();
            const quantity = parseInt(quantityInput.value) || 0; 
            let costUsd = parseFloat(costUsdInput.value) || 0;
            let costBs = parseFloat(costBsInput.value) || 0;

            if (!name || (costUsd <= 0 && costBs <= 0) || quantity <= 0) {
                showNotification('Verifique nombre, cantidad y costo unitario.', 'warning');
                return;
            }
            
            // Lógica de Conversión Final (Asegurar que ambos campos tienen valor si la tasa está disponible)
            // Ya que el usuario pudo haber editado un solo campo, nos basamos en el que no es cero
            if (financialConfig.exchangeRate > 0) {
                if (costBs === 0 && costUsd > 0) {
                    costBs = costUsd * financialConfig.exchangeRate;
                } else if (costUsd === 0 && costBs > 0) {
                    costUsd = costBs / financialConfig.exchangeRate;
                }
                // Si ambos tienen valores, se asume que el usuario los ajustó manualmente.
            }

            const index = products.findIndex(p => p.id === id);
            if (index !== -1) {
                products[index].name = name;
                products[index].quantity = quantity; 
                products[index].costUsd = costUsd;
                products[index].costBs = costBs;
                
                saveProducts();
                renderInventory();
                resetForm();
                showNotification(`Producto "${name}" actualizado.`, 'success');
            }
        }

        // Eliminar producto
        window.deleteProduct = function(id) {
            const index = products.findIndex(p => p.id === id);
            if (index !== -1) {
                const productName = products[index].name;
                products.splice(index, 1);
                saveProducts();
                renderInventory();
                showNotification(`Producto "${productName}" eliminado.`, 'danger');
            }
        }

        // Resetear el formulario de producto
        function resetForm() {
            currentEditingId = null;
            productNameInput.value = '';
            quantityInput.value = '1'; 
            costUsdInput.value = '0.00';
            costBsInput.value = '0.00';
            
            addProductBtn.classList.remove('hidden');
            updateProductBtn.classList.add('hidden');
            cancelEditBtn.classList.add('hidden');
            formTitle.textContent = 'Agregar Nuevo Producto';
            document.getElementById('product-form-card').classList.remove('border-4', 'border-edit-color', 'shadow-2xl');
        }
        
        // --- Manejo de la Exportación a PDF ---

        function exportInventoryToPDF() {
            // Inicializa jsPDF con tamaño A4
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let y = margin;
            
            // Recalcular presupuestos totales y saldos para el PDF
            const totalBsSpent = calculateBsTotal();
            const totalUsdSpent = calculateUsdTotal();
            const rate = financialConfig.exchangeRate;

            let totalBsBudget = financialConfig.initialBsBalance;
            let totalUsdBudget = financialConfig.initialUsdBalance;
            if (rate > 0) {
                totalBsBudget += (financialConfig.initialUsdBalance * rate);
                totalUsdBudget += (financialConfig.initialBsBalance / rate);
            }

            const remainingBsBalance = totalBsBudget - totalBsSpent; 
            const remainingUsdBalance = totalUsdBudget - totalUsdSpent;
            
            let remainingBsInUsd = 0;
            let remainingUsdInBs = 0;

            if (rate > 0) {
                remainingBsInUsd = remainingBsBalance / rate;
                remainingUsdInBs = remainingUsdBalance * rate;
            }

            // Título
            doc.setFontSize(18);
            doc.text("Inventario de Productos (Bs. / USD)", pageWidth / 2, y, { align: 'center' });
            y += 8;

            // Resumen Financiero
            doc.setFontSize(10);
            doc.text(`Tasa de Cambio (Bs./USD): ${financialConfig.exchangeRate.toFixed(2)}`, margin, y);
            y += 5;
            doc.text(`Saldo Inicial Propio (Bs.): ${financialConfig.initialBsBalance.toFixed(2)} Bs. | Saldo Inicial Propio (USD): ${financialConfig.initialUsdBalance.toFixed(2)} USD`, margin, y);
            y += 5;
            // Etiqueta del Presupuesto sin la palabra "Combinado"
            doc.text(`Presupuesto Total (Bs.): ${totalBsBudget.toFixed(2)} Bs. | Presupuesto Total (USD): ${totalUsdBudget.toFixed(2)} USD`, margin, y);
            y += 5;
            doc.text(`Total Gastado (Bs.): ${totalBsSpent.toFixed(2)} Bs. | Total Gastado (USD): ${totalUsdSpent.toFixed(2)} USD`, margin, y);
            y += 5;
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(`SALDO RESTANTE FINAL (Bs.): ${remainingBsBalance.toFixed(2)} Bs. (Equiv. ${remainingBsInUsd.toFixed(2)} USD)`, margin, y);
            y += 5;
            doc.text(`SALDO RESTANTE FINAL (USD): ${remainingUsdBalance.toFixed(2)} USD (Equiv. ${remainingUsdInBs.toFixed(2)} Bs.)`, margin, y);
            doc.setFont('helvetica', 'normal');
            y += 5;
            
            // Encabezados de la tabla 
            const tableHeaders = [
                { title: "Producto", dataKey: "name" },
                { title: "Cantidad", dataKey: "quantity" },
                { title: "Costo Unit. (USD)", dataKey: "costUsd" },
                { title: "Costo Unit. (Bs.)", dataKey: "costBs" },
                { title: "Total (USD)", dataKey: "totalUsd" },
                { title: "Total (Bs.)", dataKey: "totalBs" }
            ];
            
            // Datos de la tabla 
            const tableData = products.map(p => {
                const totalCostUsd = (parseFloat(p.costUsd) || 0) * (parseInt(p.quantity) || 0);
                const totalCostBs = (parseFloat(p.costBs) || 0) * (parseInt(p.quantity) || 0);
                return {
                    name: p.name,
                    quantity: p.quantity,
                    costUsd: (parseFloat(p.costUsd) || 0).toFixed(2),
                    costBs: (parseFloat(p.costBs) || 0).toFixed(2),
                    totalUsd: totalCostUsd.toFixed(2),
                    totalBs: totalCostBs.toFixed(2)
                };
            });
            
            // Generación de la tabla
            doc.autoTable({
                startY: y,
                head: [tableHeaders.map(h => h.title)],
                body: tableData.map(row => tableHeaders.map(h => row[h.dataKey])),
                theme: 'striped',
                headStyles: { 
                    fillColor: [0, 56, 101], // secondary-usd color en RGB
                    fontSize: 8 
                },
                styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
                margin: { top: margin, right: margin, bottom: margin, left: margin }
            });

            // Guardar el PDF
            doc.save(`Inventario_Dual_${new Date().toISOString().slice(0, 10)}.pdf`);
            showNotification('Inventario exportado a PDF.', 'info');
        }

        // --- Inicialización y Event Listeners ---

        function setupClearOnFocus() {
            // Limpia el valor predeterminado '0.00' al enfocar
            [rateInput, initialUsdInput, initialBsInput, costUsdInput, costBsInput, quantityInput].forEach(input => {
                input.addEventListener('focus', function() {
                    // Solo limpia si es '0.00', '0', o '1' (para cantidad)
                    if (['0.00', '0', '1'].includes(this.value)) {
                        this.value = '';
                    }
                });
                input.addEventListener('blur', function() {
                    // Restablece valores por defecto si está vacío
                    if (this.value === '' || isNaN(parseFloat(this.value))) {
                        if (this.id === 'quantity') {
                            this.value = '1';
                        } else {
                            this.value = '0.00';
                        }
                    }
                });
            });
        }
        
        // 1. Manejadores de configuración
        saveConfigBtn.addEventListener('click', saveFinancialConfig);

        // AGREGAR LISTENERS PARA ACTUALIZAR EL EQUIVALENTE AL CAMBIAR CUALQUIER SALDO O LA TASA
        [rateInput, initialUsdInput, initialBsInput].forEach(input => {
            input.addEventListener('input', updateEquivalentBalance);
        });


        // 2. Manejadores de adición y actualización de productos
        addProductBtn.addEventListener('click', addNewProduct);
        updateProductBtn.addEventListener('click', updateProduct);

        // 3. Manejadores para limpieza de inventario
        clearInventoryBtn.addEventListener('click', () => {
            clearConfirmationBox.classList.remove('hidden');
        });

        cancelClearBtn.addEventListener('click', () => {
            clearConfirmationBox.classList.add('hidden');
        });

        confirmClearBtn.addEventListener('click', () => {
            products = [];
            saveProducts();
            renderInventory();
            clearConfirmationBox.classList.add('hidden');
            resetForm();
            showNotification('Inventario borrado completamente.', 'danger');
        });

        // 4. Manejador de exportación
        exportPdfBtn.addEventListener('click', exportInventoryToPDF);

        // 5. Manejador de cancelación de edición
        cancelEditBtn.addEventListener('click', resetForm);

        // 6. Inicializar la aplicación al cargar la página
        window.onload = function() {
            loadFinancialConfig(); 
            loadProducts();
            
            setupClearOnFocus();
            
            // Configurar listeners de entrada de precios para manejar la conversión en tiempo real
            costUsdInput.addEventListener('input', () => handlePriceInput('usd'));
            costBsInput.addEventListener('input', () => handlePriceInput('bs'));
            
            renderInventory(); 
        };
    </script>
</body>
</html>
