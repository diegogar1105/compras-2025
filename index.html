<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Offline (Bs. / USD)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de Tailwind para usar el color primario y la fuente Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-bs': '#4a7c59', // Tono de verde amigable (Verde)
                        'secondary-usd': '#003865', // Azul oscuro (USD)
                        'warning-bs': '#ffc107', // Amarillo para advertencias/saldo
                        'edit-color': '#f97316', // Naranja para el modo edición
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Carga de la fuente Inter de Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Carga de las librerías jspdf y jspdf-autotable para generar el PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.js"></script>
    <style>
        /* Estilos personalizados para el fondo y la tabla */
        body {
            background-color: #f8f9fa;
            font-family: 'Inter', sans-serif;
        }
        .container-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Clase para un mejor espaciado en la tabla móvil */
        @media (max-width: 640px) {
            #inventory-table td, #inventory-table th {
                padding: 0.5rem 0.25rem;
                font-size: 0.8rem;
            }
            .sm\:flex-col-reverse {
                flex-direction: column-reverse; /* Reversa el orden de los botones en móvil */
            }
        }
        /* Estilo para campo de solo lectura en modo edición */
        input[readonly] {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        .text-na {
            color: #6c757d; /* Gris para "No Aplica" */
            font-style: italic;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">
    
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-primary-bs mb-1">Control de Inventario</h1>
            <p class="text-secondary-usd text-lg font-medium">Gestión de Productos en USD y Bs.</p>
        </header>

        <!-- Sección de Tasa de Cambio y Saldo Inicial -->
        <section id="rate-section" class="bg-white p-6 rounded-xl mb-6 container-card border border-gray-100">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 flex items-center">
                <svg class="w-6 h-6 mr-2 text-warning-bs" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V6m0 4v2m0 2v2m0 0a3 3 0 01-3 3h6a3 3 0 01-3-3m-6 3a3 3 0 00-3 3v1h18v-1a3 3 0 00-3-3m-6 0h.01"></path></svg>
                Configuración Financiera
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                <!-- Tasa de Cambio -->
                <div class="flex flex-col gap-2">
                    <label for="exchange-rate" class="block text-sm font-medium text-gray-500 mb-1">Tasa de Cambio (Bs. / $1 USD)</label>
                    <input type="number" step="0.01" min="0.01" id="exchange-rate" placeholder="Ej: 36.50"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-bs focus:border-primary-bs transition duration-150 ease-in-out">
                    <p id="current-rate-display" class="text-sm text-gray-600 font-medium"></p>
                </div>

                <!-- Saldo Inicial en Bs. -->
                <div class="flex flex-col gap-2">
                    <label for="initial-balance-bs" class="block text-sm font-medium text-gray-500 mb-1">Saldo Inicial (Bolívares Bs.)</label>
                    <input type="number" step="0.01" min="0" id="initial-balance-bs" placeholder="Ej: 1000.00"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-bs focus:border-primary-bs transition duration-150 ease-in-out">
                    <p id="current-balance-display" class="text-sm text-gray-600 font-medium"></p>
                </div>
                
                <!-- Botones de Guardar y Restaurar (En reversa en móvil) -->
                <div class="w-full md:col-span-2 flex flex-col-reverse sm:flex-row gap-4 mt-2">
                    <button onclick="saveFinancialConfig()"
                            class="flex-1 px-6 py-2 bg-primary-bs text-white font-semibold rounded-lg hover:bg-primary-bs/90 transition duration-150 ease-in-out shadow-md">
                        Guardar Tasa y Saldo
                    </button>
                    <!-- Botón de Restaurar Todo -->
                    <button onclick="resetAllDataConfirmation()"
                            class="flex-1 px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-150 ease-in-out shadow-md">
                        <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 19m15.356-2H15V12"></path></svg>
                        Restaurar Todo
                    </button>
                </div>
            </div>
        </section>

        <!-- Sección de Agregar/Editar Producto -->
        <section id="product-section" class="bg-white p-6 rounded-xl mb-6 container-card border border-gray-100">
            <h2 id="product-section-title" class="text-xl font-semibold mb-4 text-gray-700 flex items-center">
                <svg id="product-section-icon" class="w-6 h-6 mr-2 text-primary-bs" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Añadir Nuevo Producto
            </h2>
            <form id="product-form" class="grid grid-cols-1 sm:grid-cols-4 gap-4 items-end">
                <input type="hidden" id="editing-product-id" value="">
                
                <!-- Nombre del Producto (Solo lectura en modo edición) -->
                <div class="sm:col-span-4 md:col-span-2">
                    <label for="product-name" class="block text-sm font-medium text-gray-500 mb-1">Nombre del Producto</label>
                    <input type="text" id="product-name" required placeholder="Ej: Camisa Deportiva"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-bs focus:border-primary-bs"
                           title="Este campo se marca como solo lectura al editar.">
                </div>
                
                <!-- Precio USD (Columna 1 de 2 en móvil, columna 3 en desktop) -->
                <div>
                    <label for="product-price-usd" class="block text-sm font-medium text-gray-500 mb-1">Precio (USD $)</label>
                    <input type="number" step="0.01" min="0" id="product-price-usd" placeholder="Ej: 15.00"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-secondary-usd focus:border-secondary-usd">
                </div>

                <!-- Precio Bs. (Columna 2 de 2 en móvil, columna 4 en desktop) -->
                <div>
                    <label for="product-price-bs" class="block text-sm font-medium text-gray-500 mb-1">Precio (Bs.)</label>
                    <input type="number" step="0.01" min="0" id="product-price-bs" placeholder="Ej: 547.50"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-bs focus:border-primary-bs">
                </div>

                <!-- Cantidad (Nueva fila en móvil, misma fila en desktop) -->
                <div class="sm:col-span-2"> 
                    <label for="product-quantity" class="block text-sm font-medium text-gray-500 mb-1">Cantidad</label>
                    <input type="number" step="1" min="1" id="product-quantity" required placeholder="Ej: 5"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-secondary-usd focus:border-secondary-usd">
                </div>
                
                <!-- Botón de Añadir/Modificar -->
                <button type="submit" id="submit-btn"
                        class="w-full sm:col-span-2 px-6 py-2 bg-secondary-usd text-white font-semibold rounded-lg hover:bg-secondary-usd/90 transition duration-150 ease-in-out shadow-md">
                    Añadir a Inventario
                </button>
            </form>
            <button type="button" id="cancel-edit-btn" onclick="cancelEditMode()"
                    class="w-full sm:col-span-4 lg:col-span-1 px-6 py-1 mt-2 bg-gray-400 text-white font-semibold rounded-lg hover:bg-gray-500 transition duration-150 ease-in-out shadow-md hidden">
                Cancelar Edición
            </button>
        </section>
        
        <!-- Sección de Inventario -->
        <section id="inventory-section" class="bg-white p-6 rounded-xl container-card border border-gray-100">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 flex items-center">
                <svg class="w-6 h-6 mr-2 text-primary-bs" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>
                Inventario Actual
            </h2>
            
            <div class="overflow-x-auto relative rounded-lg mb-4">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-white uppercase bg-primary-bs">
                        <tr>
                            <th scope="col" class="py-3 px-2 sm:px-4">Producto</th>
                            <th scope="col" class="py-3 px-2 sm:px-4 text-center">Cant.</th>
                            <th scope="col" class="py-3 px-2 sm:px-4 text-right">Precio ($)</th>
                            <th scope="col" class="py-3 px-2 sm:px-4 text-right">Subtotal (Bs.)</th>
                            <th scope="col" class="py-3 px-2 sm:px-4 text-center print:hidden">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-body">
                        <!-- Filas de productos se insertarán aquí -->
                    </tbody>
                </table>
                <p id="empty-message" class="text-center py-4 text-gray-500 bg-white" style="display:none;">
                    No hay productos en el inventario.
                </p>
            </div>

            <!-- Totales Generales y Resumen de Saldo -->
            <div id="totals-summary" class="flex flex-col sm:flex-row sm:justify-between items-start sm:items-center mt-2 p-4 rounded-xl bg-gray-100 border border-gray-200">
                <!-- Totales y Saldos -->
                <div class="mb-4 sm:mb-0 space-y-1">
                    <p class="text-base font-bold text-gray-700">Total General (USD): <span id="total-usd" class="text-secondary-usd ml-2 text-lg"></span></p>
                    <p class="text-base font-bold text-gray-700">Total General (Bs.): <span id="total-bs" class="text-primary-bs ml-2 text-lg"></span></p>
                    <hr class="my-1 border-gray-300">
                    <!-- Nuevos campos de Saldo Restante -->
                    <p class="text-base font-bold text-gray-700">Saldo Inicial (Bs.): <span id="initial-balance-display-2" class="text-lg ml-2 font-extrabold text-primary-bs"></span></p>
                    <p class="text-base font-bold text-gray-700">Saldo Restante (Bs.): <span id="remaining-balance-bs" class="text-lg ml-2 font-extrabold"></span></p>
                    <p class="text-base font-bold text-gray-700">Saldo Restante (USD): <span id="remaining-balance-usd" class="text-lg ml-2 font-extrabold"></span></p>
                </div>
            </div>

            <!-- Botón de Exportar a PDF -->
            <div class="mt-4 flex justify-end">
                <button onclick="exportToPDF()" id="export-btn" disabled
                        class="w-full sm:w-auto px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-150 ease-in-out shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Exportar a PDF
                </button>
            </div>
        </section>
        
        <!-- Modal de Mensajes/Confirmación -->
        <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg max-w-sm w-full shadow-2xl">
                <h3 id="modal-title" class="text-lg font-bold mb-3 text-red-600">Error</h3>
                <p id="modal-body" class="text-gray-700 mb-4">Mensaje de error.</p>
                <div class="flex justify-end">
                    <!-- Botones dinámicos se insertan aquí -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Definición de variables globales y claves de almacenamiento
        let exchangeRate = 0;
        let initialBalanceBs = null; // Cero inicialmente, pero null si no ha sido guardado por el usuario
        const RATE_KEY = 'inventarioRate';
        const BALANCE_KEY = 'inventarioBalanceBs';
        const PRODUCTS_KEY = 'inventarioProducts';
        
        // ID del producto actualmente en edición (null si no se está editando)
        let editingProductId = null; 

        // Referencias a inputs del formulario para evitar múltiples lookups
        const nameInput = document.getElementById('product-name');
        const usdInput = document.getElementById('product-price-usd');
        const bsInput = document.getElementById('product-price-bs');
        const quantityInput = document.getElementById('product-quantity');
        const formEl = document.getElementById('product-form');

        // --- Funciones de Utilidad y UI (Modales) ---

        /** Muestra un modal con mensaje (isConfirm=false) o confirmación (isConfirm=true). */
        function showModal(title, body, isError = true, isConfirm = false, onConfirm = () => {}) {
            document.getElementById('modal-title').textContent = title;
            // Establecer color del título
            let titleColor = isError && !isConfirm ? 'text-red-600' : 'text-primary-bs';
            document.getElementById('modal-title').className = `text-lg font-bold mb-3 ${titleColor}`;
            document.getElementById('modal-body').textContent = body;
            
            const footer = document.getElementById('message-modal').querySelector('.flex.justify-end');
            footer.innerHTML = ''; // Limpiar botones

            if (isConfirm) {
                const confirmButton = document.createElement('button');
                confirmButton.textContent = 'Sí, continuar';
                confirmButton.className = 'px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 mr-2 transition duration-150';
                confirmButton.onclick = () => { hideModal(); onConfirm(true); };
                
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Cancelar';
                cancelButton.className = 'px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-150';
                cancelButton.onclick = () => { hideModal(); onConfirm(false); };
                
                footer.appendChild(confirmButton);
                footer.appendChild(cancelButton);
            } else {
                 const closeButton = document.createElement('button');
                 closeButton.textContent = 'Cerrar';
                 closeButton.className = 'px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-150';
                 closeButton.onclick = hideModal;
                 footer.appendChild(closeButton);
            }

            document.getElementById('message-modal').classList.remove('hidden');
            document.getElementById('message-modal').classList.add('flex');
        }

        /** Oculta el modal de mensaje. */
        function hideModal() {
            document.getElementById('message-modal').classList.add('hidden');
            document.getElementById('message-modal').classList.remove('flex');
        }

        /** Simula window.confirm() usando el modal custom. */
        function customConfirm(message) {
             return new Promise((resolve) => {
                 showModal('Confirmar Acción', message, false, true, resolve);
             });
         }

        /** Formatea un número como Bolívares (Bs.). */
        const formatBs = (value) => {
            // Usar 'es-VE' para formato de Venezuela (coma como separador decimal)
            return new Intl.NumberFormat('es-VE', { 
                style: 'currency', 
                currency: 'VEF', 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            }).format(value).replace('VEF', 'Bs.');
        };

        /** Formatea un número como Dólares Americanos (USD $). */
        const formatUsd = (value) => {
            return new Intl.NumberFormat('en-US', { 
                style: 'currency', 
                currency: 'USD', 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            }).format(value);
        };
        
        // --- Manejo de Conversión y Sincronización de Precios ---

        /** * Maneja la entrada de precios (USD o Bs.) y calcula la conversión. */
        function handlePriceInput(source) {
            const rate = exchangeRate;
            
            // Si no hay tasa, no se sincronizan los campos.
            if (rate <= 0) return;

            if (source === 'usd') {
                const usdValue = parseFloat(usdInput.value) || 0;
                if (usdValue > 0) {
                    const bsEquivalent = usdValue * rate;
                    bsInput.value = bsEquivalent.toFixed(2);
                } else if (usdInput.value.trim() === '') {
                    bsInput.value = '';
                }
            } else if (source === 'bs') {
                const bsValue = parseFloat(bsInput.value) || 0;
                if (bsValue > 0) {
                    const usdEquivalent = bsValue / rate;
                    usdInput.value = usdEquivalent.toFixed(2);
                } else if (bsInput.value.trim() === '') {
                    usdInput.value = '';
                }
            }
        }

        // --- Manejo de la Tasa de Cambio y Saldo ---

        /** Guarda la configuración financiera (tasa y saldo) en localStorage y actualiza la UI. */
        function saveFinancialConfig() {
            const rateInputEl = document.getElementById('exchange-rate');
            const balanceInputEl = document.getElementById('initial-balance-bs');
            
            const newRate = parseFloat(rateInputEl.value);
            const newBalance = parseFloat(balanceInputEl.value);

            let rateUpdated = false;
            let balanceUpdated = false;

            // 1. Validar y guardar la tasa
            if (rateInputEl.value.trim() !== "") {
                if (!isNaN(newRate) && newRate > 0) {
                    exchangeRate = newRate;
                    localStorage.setItem(RATE_KEY, newRate.toString());
                    rateUpdated = true;
                } else {
                    showModal("Error de Tasa", "La Tasa de Cambio debe ser un valor numérico positivo.", true);
                    return;
                }
            }

            // 2. Validar y guardar el saldo inicial
            if (balanceInputEl.value.trim() !== "") {
                if (!isNaN(newBalance) && newBalance >= 0) {
                    initialBalanceBs = newBalance;
                    localStorage.setItem(BALANCE_KEY, newBalance.toString());
                    balanceUpdated = true;
                } else {
                    showModal("Error de Saldo", "El Saldo Inicial debe ser un valor numérico positivo o cero.", true);
                    return;
                }
            } else if (balanceInputEl.value.trim() === "" && localStorage.getItem(BALANCE_KEY) !== null) {
                // Si el usuario borra el campo y ya había un valor, reseteamos el saldo (opcional)
                // En este caso, si no ingresa nada, simplemente no actualizamos el saldo.
            }
             if (balanceInputEl.value.trim() === "" && localStorage.getItem(BALANCE_KEY) !== null) {
                // Si el usuario borra el campo, establecemos el saldo a null para que no se reste
                initialBalanceBs = null;
                localStorage.removeItem(BALANCE_KEY);
                balanceUpdated = true; // Forzamos la actualización de la UI
            }
          

            if (rateUpdated || balanceUpdated) {
                renderInventory();
                rateInputEl.value = '';
                balanceInputEl.value = '';
                
                let message = `Configuración actualizada.`;
                if(rateUpdated) message += ` Tasa: 1 USD = ${formatBs(exchangeRate)}`;
                if(balanceUpdated) message += ` Saldo Inicial: ${initialBalanceBs !== null ? formatBs(initialBalanceBs) : 'No establecido'}`;
                showModal("Configuración Guardada", message, false);
            } else {
                showModal("Advertencia", "No se ingresaron valores válidos para actualizar la Tasa o el Saldo.", true);
            }
        }

        /** Carga la configuración financiera desde localStorage. */
        function loadFinancialConfig() {
            // Cargar Tasa
            const storedRate = localStorage.getItem(RATE_KEY);
            exchangeRate = storedRate ? parseFloat(storedRate) : 0;
            const rateDisplay = document.getElementById('current-rate-display');
            if (exchangeRate > 0) {
                rateDisplay.textContent = `Tasa guardada: 1 USD = ${formatBs(exchangeRate)}`;
                rateDisplay.classList.remove('text-red-500');
                rateDisplay.classList.add('text-primary-bs');
            } else {
                rateDisplay.textContent = '¡Advertencia! Tasa de cambio no establecida.';
                rateDisplay.classList.remove('text-primary-bs');
                rateDisplay.classList.add('text-red-500');
            }

            // Cargar Saldo Inicial (Usamos 'null' si no existe)
            const storedBalance = localStorage.getItem(BALANCE_KEY);
            initialBalanceBs = storedBalance ? parseFloat(storedBalance) : null;
            const balanceDisplay = document.getElementById('current-balance-display');
            if (initialBalanceBs !== null) {
                balanceDisplay.textContent = `Saldo inicial guardado: ${formatBs(initialBalanceBs)}`;
                balanceDisplay.classList.add('text-primary-bs');
                balanceDisplay.classList.remove('text-red-500');
            } else {
                 balanceDisplay.textContent = `Saldo inicial: No establecido.`;
                 balanceDisplay.classList.add('text-red-500');
                 balanceDisplay.classList.remove('text-primary-bs');
            }
        }
              
        // --- Funcionalidad de Restaurar Todo ---

        /** Pide confirmación antes de borrar todos los datos. */
        function resetAllDataConfirmation() {
            customConfirm('¿Estás seguro de que quieres RESTAURAR TODO? Esto eliminará la Tasa, Saldo Inicial y todos los Productos.')
                .then(result => {
                    if (result) {
                        resetAllData();
                    }
                });
        }

        /** Borra todos los datos y reinicia la aplicación. */
        function resetAllData() {
            localStorage.removeItem(RATE_KEY);
            localStorage.removeItem(BALANCE_KEY);
            localStorage.removeItem(PRODUCTS_KEY);
            
            // Reiniciar variables
            exchangeRate = 0;
            initialBalanceBs = null;
            products = [];
            
            // Recargar configuración y renderizar
            loadFinancialConfig();
            renderInventory();
            
            showModal("Datos Borrados", "Todos los datos (Tasa, Saldo y Productos) han sido eliminados con éxito.", false);
        }

        // --- Manejo de Productos ---

        /** Carga los productos desde localStorage. */
        let products = [];
        function loadProducts() {
            const storedProducts = localStorage.getItem(PRODUCTS_KEY);
            products = storedProducts ? JSON.parse(storedProducts) : [];
        }

        /** Guarda los productos en localStorage. */
        function saveProducts() {
            localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
        }

        /** Agrega un nuevo producto o actualiza uno existente. */
        function addOrUpdateProduct(event) {
            event.preventDefault();

            // Obtenemos los valores de los campos (incluso si está en modo readonly)
            const name = nameInput.value.trim();
            const priceUsd = parseFloat(usdInput.value);
            const quantity = parseInt(quantityInput.value);
            
            // Validación de la Tasa
            if (exchangeRate <= 0) {
                 showModal("Error", "Debes establecer una Tasa de Cambio válida antes de agregar o modificar productos.", true);
                 return;
            }

            // Validar que el precio en USD sea válido.
            if (isNaN(priceUsd) || priceUsd <= 0) {
                showModal("Error", "El precio en USD no es válido.", true);
                return;
            }
            // Validar que la cantidad sea válida
             if (isNaN(quantity) || quantity <= 0) {
                showModal("Error", "La cantidad debe ser un número entero positivo.", true);
                return;
            }
               

            // Validar si existe el producto por nombre (solo al añadir, NO al editar)
            if (editingProductId === null) {
                const existingProduct = products.find(p => p.name.toLowerCase() === name.toLowerCase());
                if (existingProduct) {
                    showModal("Error", `El producto "${name}" ya existe. Usa la opción de editar para cambiarlo.`, true);
                    return;
                }
            }

            // Calcular precio Bs. final basado en USD y la tasa actual
            const newPriceUsd = priceUsd; 
            const newPriceBs = newPriceUsd * exchangeRate; 

            // Crear el nuevo objeto producto
            const newProduct = {
                id: editingProductId || Date.now(), 
                name: name,
                priceUsd: newPriceUsd,
                priceBs: newPriceBs, 
                quantity: quantity
            };
            
            if (editingProductId !== null) {
                // Modo Edición: Encontrar y reemplazar el producto
                const index = products.findIndex(p => p.id == editingProductId);
                if (index !== -1) {
                    products[index] = newProduct;
                    showModal("Producto Modificado", `El producto "${name}" ha sido actualizado.`, false);
                }
                // Limpiar después de guardar
                cancelEditMode(); 
            } else {
                // Modo Añadir: Agregar nuevo producto
                products.push(newProduct);
                showModal("Producto Añadido", `"${name}" agregado al inventario.`, false);
                
                // Limpiar formulario y volver a modo 'Añadir'
                formEl.reset();
            }
            
            saveProducts();
            renderInventory();
        }

        /** Renderiza la tabla de inventario y recalcula los totales. */
        function renderInventory() {
            const body = document.getElementById('inventory-body');
            body.innerHTML = '';
            
            const emptyMessage = document.getElementById('empty-message');
            const exportBtn = document.getElementById('export-btn');
            
            let totalUsd = 0;
            let totalBs = 0;

            if (products.length === 0) {
                emptyMessage.style.display = 'block';
                exportBtn.disabled = true;
            } else {
                emptyMessage.style.display = 'none';
                exportBtn.disabled = false;
            }

            products.forEach(product => {
                // Recalcular subtotal en Bs. usando la tasa actual (importante si la tasa cambia)
                const subtotalBs = product.priceUsd * product.quantity * (exchangeRate || 1); 
                const subtotalUsd = product.priceUsd * product.quantity;

                totalUsd += subtotalUsd;
                totalBs += subtotalBs;

                const row = body.insertRow();
                row.className = 'bg-white border-b hover:bg-gray-50';

                // Producto (Nombre)
                let cell = row.insertCell();
                cell.textContent = product.name;
                cell.className = 'py-3 px-2 sm:px-4 font-medium text-gray-900 whitespace-nowrap';

                // Cantidad
                cell = row.insertCell();
                cell.textContent = product.quantity;
                cell.className = 'py-3 px-2 sm:px-4 text-center';

                // Precio ($)
                cell = row.insertCell();
                cell.textContent = formatUsd(product.priceUsd);
                cell.className = 'py-3 px-2 sm:px-4 text-right font-semibold text-secondary-usd';

                // Subtotal (Bs.)
                cell = row.insertCell();
                cell.textContent = formatBs(subtotalBs);
                cell.className = 'py-3 px-2 sm:px-4 text-right font-semibold text-primary-bs';

                // Acciones
                cell = row.insertCell();
                cell.className = 'py-3 px-2 sm:px-4 text-center print:hidden';
                cell.innerHTML = `
                    <div class="flex justify-center space-x-2">
                        <button type="button" onclick="editProduct(${product.id})" class="text-edit-color hover:text-edit-color/80 font-medium transition duration-150" title="Editar">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-9-4l9-9m-4 4L19 7m-4-4l-9 9"></path></svg>
                        </button>
                        <button type="button" onclick="deleteProductConfirmation(${product.id}, '${product.name}')" class="text-red-600 hover:text-red-700 font-medium transition duration-150" title="Eliminar">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
            });
                      
            // ----------------------------------------------------
            // Actualizar Totales y Saldo (Lógica corregida)
            // ----------------------------------------------------

            document.getElementById('total-usd').textContent = formatUsd(totalUsd);
            document.getElementById('total-bs').textContent = formatBs(totalBs);

            const remainingBsEl = document.getElementById('remaining-balance-bs');
            const remainingUsdEl = document.getElementById('remaining-balance-usd');
            const initialBalanceDisplay2 = document.getElementById('initial-balance-display-2');
            
            // 1. Mostrar Saldo Inicial
            if (initialBalanceBs !== null) {
                initialBalanceDisplay2.textContent = formatBs(initialBalanceBs);
                initialBalanceDisplay2.classList.remove('text-na');

                // 2. Calcular y mostrar Saldo Restante (SOLO si hay Saldo Inicial)
                const remainingBs = initialBalanceBs - totalBs;
                const remainingUsd = exchangeRate > 0 ? remainingBs / exchangeRate : 0; 

                remainingBsEl.textContent = formatBs(remainingBs);
                remainingUsdEl.textContent = formatUsd(remainingUsd);
                remainingBsEl.classList.remove('text-na');
                remainingUsdEl.classList.remove('text-na');

                // Cambiar color del saldo restante si es negativo
                if (remainingBs < 0) {
                    remainingBsEl.classList.remove('text-primary-bs');
                    remainingBsEl.classList.add('text-red-600');
                    remainingUsdEl.classList.remove('text-secondary-usd');
                    remainingUsdEl.classList.add('text-red-600');
                } else {
                    remainingBsEl.classList.add('text-primary-bs');
                    remainingBsEl.classList.remove('text-red-600');
                    remainingUsdEl.classList.add('text-secondary-usd');
                    remainingUsdEl.classList.remove('text-red-600');
                }

            } else {
                // 3. Mostrar N/A si no hay Saldo Inicial
                initialBalanceDisplay2.textContent = 'N/A';
                initialBalanceDisplay2.classList.add('text-na');
                
                remainingBsEl.textContent = 'N/A';
                remainingBsEl.className = 'text-lg ml-2 font-extrabold text-na'; 

                remainingUsdEl.textContent = 'N/A';
                remainingUsdEl.className = 'text-lg ml-2 font-extrabold text-na'; 
            }
        }

        /** Entra en modo edición para un producto. */
        function editProduct(id) {
            const product = products.find(p => p.id == id);
            if (!product) return;
            
            // Paso 1: Limpiar el formulario y establecer el ID de edición
            formEl.reset(); 
            editingProductId = id;

            // Paso 2: Actualizar UI del formulario a modo Edición
            document.getElementById('product-section-title').textContent = 'Editar Producto';
            document.getElementById('product-section-icon').classList.remove('text-primary-bs');
            document.getElementById('product-section-icon').classList.add('text-edit-color');
            document.getElementById('submit-btn').textContent = 'Modificar Producto';
            document.getElementById('submit-btn').classList.remove('bg-secondary-usd');
            document.getElementById('submit-btn').classList.add('bg-edit-color');
            document.getElementById('cancel-edit-btn').classList.remove('hidden');

            // Paso 3: Llenar y configurar campos
            
            // Nombre: Marcamos como SOLO LECTURA, no disabled, para que el valor se envíe al guardar
            nameInput.value = product.name;
            nameInput.readOnly = true; 
            
            // Precio USD (Referencia)
            usdInput.value = product.priceUsd.toFixed(2);
            
            // Precio Bs. (Calculado con la tasa actual o la tasa guardada del producto)
            const priceBsDisplay = exchangeRate > 0 ? (product.priceUsd * exchangeRate).toFixed(2) : product.priceBs.toFixed(2);
            bsInput.value = priceBsDisplay; 
            
            // Cantidad
            quantityInput.value = product.quantity;

            window.scrollTo(0, 0); // Desplazarse al formulario
        }
  
        /** Sale del modo edición y resetea el formulario a modo 'Añadir'. */
        function cancelEditMode() {
            editingProductId = null;
            
            // Restablecer UI del formulario
            document.getElementById('product-section-title').textContent = 'Añadir Nuevo Producto';
            document.getElementById('product-section-icon').classList.add('text-primary-bs');
            document.getElementById('product-section-icon').classList.remove('text-edit-color');
            document.getElementById('submit-btn').textContent = 'Añadir a Inventario';
            document.getElementById('submit-btn').classList.add('bg-secondary-usd');
            document.getElementById('submit-btn').classList.remove('bg-edit-color');
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            
            // Limpiar y habilitar campos
            formEl.reset();
            
            // Habilitar el campo de nombre (quitar readonly)
            nameInput.readOnly = false; 
            nameInput.focus();
        }

        /** Pide confirmación antes de borrar un producto. */
        function deleteProductConfirmation(id, name) {
            customConfirm(`¿Estás seguro de que quieres eliminar el producto "${name}" del inventario?`)
                .then(result => {
                    if (result) {
                        deleteProduct(id, name);
                    }
                });
        }

        /** Elimina un producto por ID. */
        function deleteProduct(id, name) {
            products = products.filter(p => p.id != id);
            saveProducts();
            renderInventory();
            showModal("Producto Eliminado", `"${name}" ha sido eliminado del inventario.`, false);
        }

        // --- Funcionalidad de Exportación a PDF ---
        
        /** Exporta la tabla de inventario y el resumen a un documento PDF. */
        function exportToPDF() {
            if (products.length === 0) {
                 showModal("Error de Exportación", "No hay productos en el inventario para exportar.", true);
                 return;
            }
          
            // Inicializar jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            const margin = 40;
            let currentY = margin;
            
            // 1. Título
            doc.setFontSize(18);
            doc.text("Reporte de Inventario", margin, currentY);
            currentY += 25;
            
            // 2. Información Financiera
            doc.setFontSize(10);
            const rateText = document.getElementById('current-rate-display').textContent;
            const balanceText = document.getElementById('current-balance-display').textContent;
            
            doc.text(`Tasa de Cambio: ${rateText.replace('Tasa guardada: ', '')}`, margin, currentY);
            currentY += 15;
            doc.text(`Saldo Inicial Guardado: ${initialBalanceBs !== null ? formatBs(initialBalanceBs) : 'No Establecido'}`, margin, currentY);
            currentY += 25;

            // 3. Tabla de Productos
            const tableData = products.map(product => {
                 // Usar la tasa actual al exportar
                 const subtotalBs = product.priceUsd * product.quantity * (exchangeRate || 1); 
                 return [
                     product.name,
                     product.quantity.toString(),
                     formatUsd(product.priceUsd),
                     formatBs(subtotalBs)
                 ];
            });

            doc.autoTable({
                startY: currentY,
                head: [['Producto', 'Cantidad', 'Precio ($)', 'Subtotal (Bs.)']],
                body: tableData,
                styles: {
                    fontSize: 10,
                    cellPadding: 5,
                    textColor: 50,
                },
                headStyles: {
                    fillColor: [74, 124, 89], // primary-bs (Verde)
                    textColor: 255,
                    fontStyle: 'bold'
                },
                columnStyles: {
                    2: { halign: 'right' }, // Precio $
                    3: { halign: 'right' }  // Subtotal Bs.
                },
                didDrawPage: (data) => {
                    currentY = data.cursor.y;
                }
            });

            // 4. Totales y Saldo (después de la tabla)
            currentY = doc.autoTable.previous.finalY + 20;

            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            
            const totalUsdText = document.getElementById('total-usd').textContent;
            const totalBsText = document.getElementById('total-bs').textContent;
            
            const isBalanceSet = initialBalanceBs !== null;
            const remainingBsValue = isBalanceSet ? initialBalanceBs - totalBs : 0;
            const remainingBsText = isBalanceSet ? formatBs(remainingBsValue) : 'N/A';
            const remainingUsdText = isBalanceSet && exchangeRate > 0 ? formatUsd(remainingBsValue / exchangeRate) : 'N/A';
            
            doc.text("RESUMEN DE INVENTARIO Y SALDO", margin, currentY);
            currentY += 15;
            doc.setFont('helvetica', 'normal');

            // Cuadro resumen
            const totalWidth = doc.internal.pageSize.getWidth() - (2 * margin);
            const lineHeight = 15;
            const boxPadding = 5;
            let boxY = currentY;

            const drawSummaryLine = (text, value, isNegative = false, isNA = false) => {
                doc.text(text, margin + boxPadding, boxY + lineHeight);
                if (isNA) {
                     doc.setTextColor(108, 117, 125); // Gris para N/A
                } else {
                    doc.setTextColor(isNegative ? 255 : 0); // Rojo para negativo, negro para positivo
                }
                doc.text(value, margin + totalWidth - boxPadding, boxY + lineHeight, { align: 'right' });
                doc.setTextColor(0); // Restablecer a negro
                boxY += lineHeight + 3;
            };
            
            // Determinar altura del recuadro
            let finalBoxHeight = 0;
            if (isBalanceSet) {
                 finalBoxHeight = (4 * lineHeight) + 2*boxPadding + 3*3; // 4 líneas de texto
            } else {
                 finalBoxHeight = (2 * lineHeight) + 2*boxPadding + 1*3; // 2 líneas de texto
            }
            
            // Dibujar el recuadro final (fondo gris claro)
            doc.setFillColor(240, 240, 240); // Gris muy claro
            doc.rect(margin, currentY, totalWidth, finalBoxHeight, 'F');
            doc.rect(margin, currentY, totalWidth, finalBoxHeight, 'S'); // Borde

            // Volver a dibujar los textos dentro del recuadro
            doc.setTextColor(50); // Color de texto oscuro

            boxY = currentY;
            drawSummaryLine("Total General (USD):", totalUsdText);
            drawSummaryLine("Total General (Bs.):", totalBsText);

            if (isBalanceSet) {
                boxY += 5; // Separador
                drawSummaryLine("Saldo Inicial (Bs.):", formatBs(initialBalanceBs));
                drawSummaryLine("Saldo Restante (Bs.):", remainingBsText, remainingBsValue < 0);
                drawSummaryLine("Saldo Restante (USD):", remainingUsdText, remainingBsValue < 0);
            }


            // Guardar el PDF
            doc.save(`Inventario_Reporte_${new Date().toISOString().slice(0, 10)}.pdf`);
        }


        // --- Inicialización ---

        // Registrar el evento de envío del formulario
        formEl.addEventListener('submit', addOrUpdateProduct);

        // Inicializar la aplicación al cargar la página
        window.onload = function() {
            loadFinancialConfig();
            loadProducts();
            
            // Configurar listeners de entrada de precios para manejar la conversión en tiempo real
            usdInput.addEventListener('input', () => handlePriceInput('usd'));
            bsInput.addEventListener('input', () => handlePriceInput('bs'));
            
            renderInventory(); // Inicializa la vista con los datos guardados
        };
    </script>
</body>
</html>
          
