<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Offline (Bs. / USD)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de Tailwind para usar el color primario y la fuente Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-bs': '#4a7c59', // Tono de verde amigable
                        'secondary-usd': '#003865', // Azul oscuro
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Carga de la fuente Inter de Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Carga de las librerías jspdf y jspdf-autotable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.js"></script>
    <style>
        /* Estilos personalizados para el fondo y la tabla */
        body {
            background-color: #f8f9fa;
            font-family: 'Inter', sans-serif;
        }
        .container-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Clase para un mejor espaciado en la tabla móvil */
        @media (max-width: 640px) {
            #inventory-table td, #inventory-table th {
                padding: 0.5rem 0.25rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">
    
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-primary-bs mb-1">Control de Inventario Offline</h1>
            <p class="text-secondary-usd text-lg font-medium">Gestión de Productos en USD y Bs.</p>
        </header>

        <!-- Sección de Tasa de Cambio -->
        <section id="rate-section" class="bg-white p-6 rounded-xl mb-6 container-card border border-gray-100">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 flex items-center">
                <svg class="w-6 h-6 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V6m0 4v2m0 2v2m0 0a3 3 0 01-3 3h6a3 3 0 01-3-3m-6 3a3 3 0 00-3 3v1h18v-1a3 3 0 00-3-3m-6 0h.01"></path></svg>
                Tasa de Cambio (Bs. / $1 USD)
            </h2>
            <div class="flex flex-col sm:flex-row gap-4 items-end">
                <div class="flex-grow w-full">
                    <label for="exchange-rate" class="block text-sm font-medium text-gray-500 mb-1">Valor Actual</label>
                    <input type="number" step="0.01" min="0.01" id="exchange-rate" placeholder="Ej: 36.50"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-bs focus:border-primary-bs transition duration-150 ease-in-out">
                </div>
                <button onclick="saveExchangeRate()"
                        class="w-full sm:w-auto px-6 py-2 bg-primary-bs text-white font-semibold rounded-lg hover:bg-primary-bs/90 transition duration-150 ease-in-out shadow-md">
                    Guardar Tasa
                </button>
            </div>
            <p id="current-rate-display" class="mt-3 text-sm text-gray-600 font-medium"></p>
        </section>

        <!-- Sección de Agregar Producto -->
        <section id="product-section" class="bg-white p-6 rounded-xl mb-6 container-card border border-gray-100">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 flex items-center">
                <svg class="w-6 h-6 mr-2 text-primary-bs" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Añadir Nuevo Producto
            </h2>
            <form id="product-form" class="grid grid-cols-1 sm:grid-cols-4 gap-4 items-end">
                <div class="sm:col-span-2">
                    <label for="product-name" class="block text-sm font-medium text-gray-500 mb-1">Nombre del Producto</label>
                    <input type="text" id="product-name" required placeholder="Ej: Camisa Deportiva"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-bs focus:border-primary-bs">
                </div>
                <div>
                    <label for="product-price-usd" class="block text-sm font-medium text-gray-500 mb-1">Precio (USD $)</label>
                    <input type="number" step="0.01" min="0.01" id="product-price-usd" required placeholder="Ej: 15.00"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-secondary-usd focus:border-secondary-usd">
                </div>
                <div>
                    <label for="product-quantity" class="block text-sm font-medium text-gray-500 mb-1">Cantidad</label>
                    <input type="number" step="1" min="1" id="product-quantity" required placeholder="Ej: 5"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-secondary-usd focus:border-secondary-usd">
                </div>
                <button type="submit"
                        class="w-full sm:col-span-4 lg:col-span-1 px-6 py-2 bg-secondary-usd text-white font-semibold rounded-lg hover:bg-secondary-usd/90 transition duration-150 ease-in-out shadow-md">
                    Añadir a Inventario
                </button>
            </form>
        </section>
        
        <!-- Sección de Inventario -->
        <section id="inventory-section" class="bg-white p-6 rounded-xl container-card border border-gray-100">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 flex items-center">
                <svg class="w-6 h-6 mr-2 text-primary-bs" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>
                Inventario Actual
            </h2>

            <div class="overflow-x-auto relative shadow-md rounded-lg mb-6">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-white uppercase bg-primary-bs">
                        <tr>
                            <th scope="col" class="py-3 px-2 sm:px-4">Producto</th>
                            <th scope="col" class="py-3 px-2 sm:px-4 text-center">Cant.</th>
                            <th scope="col" class="py-3 px-2 sm:px-4 text-right">Precio ($)</th>
                            <th scope="col" class="py-3 px-2 sm:px-4 text-right">Subtotal (Bs.)</th>
                            <th scope="col" class="py-3 px-2 sm:px-4 text-center">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-body">
                        <!-- Filas de productos se insertarán aquí -->
                    </tbody>
                </table>
                <p id="empty-message" class="text-center py-4 text-gray-500 bg-white" style="display:none;">
                    No hay productos en el inventario.
                </p>
            </div>

            <!-- Totales Generales y Exportación -->
            <div id="totals-summary" class="flex flex-col sm:flex-row sm:justify-between items-start sm:items-center mt-4 p-4 rounded-xl bg-gray-50 border border-gray-200">
                <!-- Totales -->
                <div class="mb-4 sm:mb-0">
                    <p class="text-base font-bold text-gray-700">Total General USD: <span id="total-usd" class="text-secondary-usd ml-2 text-lg"></span></p>
                    <p class="text-base font-bold text-gray-700">Total General Bs.: <span id="total-bs" class="text-primary-bs ml-2 text-lg"></span></p>
                </div>
                <!-- Botón de Exportar -->
                <button onclick="exportToPDF()" id="export-btn" disabled
                        class="w-full sm:w-auto px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-150 ease-in-out shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Exportar a PDF
                </button>
            </div>
        </section>
        
        <!-- Modal de Mensajes (No usar alert()) -->
        <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg max-w-sm w-full shadow-2xl">
                <h3 id="modal-title" class="text-lg font-bold mb-3 text-red-600">Error</h3>
                <p id="modal-body" class="text-gray-700 mb-4">Mensaje de error.</p>
                <div class="flex justify-end">
                    <button onclick="hideModal()" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Definición de variables globales y claves de almacenamiento
        let exchangeRate = 0;
        let products = [];
        const RATE_KEY = 'inventarioRate';
        const PRODUCTS_KEY = 'inventarioProducts';
        const doc = window.jspdf.jsPDF; // Referencia a jspdf

        // --- Funciones de Utilidad ---

        /** Muestra un modal de mensaje de error o éxito. */
        function showModal(title, body, isError = true) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-title').className = isError ? 'text-lg font-bold mb-3 text-red-600' : 'text-lg font-bold mb-3 text-primary-bs';
            document.getElementById('modal-body').textContent = body;
            document.getElementById('message-modal').classList.remove('hidden');
            document.getElementById('message-modal').classList.add('flex');
        }

        /** Oculta el modal de mensaje. */
        function hideModal() {
            document.getElementById('message-modal').classList.add('hidden');
            document.getElementById('message-modal').classList.remove('flex');
        }

        /** Formatea un número como Bolívares (Bs.). */
        const formatBs = (value) => {
            // Usar 'es-VE' para formato de Venezuela (coma como separador decimal)
            return new Intl.NumberFormat('es-VE', { style: 'currency', currency: 'VEF', minimumFractionDigits: 2 }).format(value).replace('VEF', 'Bs.');
        };

        /** Formatea un número como Dólares Americanos (USD $). */
        const formatUsd = (value) => {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(value);
        };
        
        // --- Manejo de la Tasa de Cambio ---

        /** Guarda la tasa de cambio en localStorage y actualiza la UI. */
        function saveExchangeRate() {
            const rateInput = document.getElementById('exchange-rate');
            const newRate = parseFloat(rateInput.value);

            if (isNaN(newRate) || newRate <= 0) {
                showModal("Error de Tasa", "Por favor, ingrese una tasa de cambio válida y positiva (Bs. por $1 USD).", true);
                return;
            }

            exchangeRate = newRate;
            localStorage.setItem(RATE_KEY, newRate.toString());
            renderInventory();
            rateInput.value = ''; // Limpiar campo después de guardar
            showModal("Tasa Guardada", `La tasa de cambio se ha actualizado a ${formatBs(newRate)} por $1 USD.`, false);
        }

        /** Carga la tasa de cambio desde localStorage. */
        function loadExchangeRate() {
            const storedRate = localStorage.getItem(RATE_KEY);
            exchangeRate = storedRate ? parseFloat(storedRate) : 0;

            const rateDisplay = document.getElementById('current-rate-display');
            if (exchangeRate > 0) {
                rateDisplay.textContent = `Tasa actual: 1 USD = ${formatBs(exchangeRate)}`;
                rateDisplay.classList.remove('text-red-500');
                rateDisplay.classList.add('text-primary-bs');
            } else {
                rateDisplay.textContent = '¡Advertencia! Tasa de cambio no establecida. No se pueden calcular los totales en Bs.';
                rateDisplay.classList.remove('text-primary-bs');
                rateDisplay.classList.add('text-red-500');
            }
        }

        // --- Manejo de Productos ---

        /** Guarda el array de productos en localStorage. */
        function saveProducts() {
            localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
        }

        /** Carga el array de productos desde localStorage. */
        function loadProducts() {
            const storedProducts = localStorage.getItem(PRODUCTS_KEY);
            try {
                products = storedProducts ? JSON.parse(storedProducts) : [];
            } catch (e) {
                console.error("Error al parsear productos desde localStorage:", e);
                products = [];
            }
        }
        
        /** Añade un producto al inventario. */
        document.getElementById('product-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const name = document.getElementById('product-name').value.trim();
            const priceUSD = parseFloat(document.getElementById('product-price-usd').value);
            const quantity = parseInt(document.getElementById('product-quantity').value);

            if (!name || isNaN(priceUSD) || priceUSD <= 0 || isNaN(quantity) || quantity <= 0) {
                showModal("Datos Inválidos", "Por favor, complete todos los campos con valores positivos y válidos.", true);
                return;
            }

            const newProduct = {
                id: Date.now(), // ID único basado en timestamp
                name: name,
                priceUSD: priceUSD,
                quantity: quantity
            };

            products.push(newProduct);
            saveProducts();
            renderInventory();

            // Limpiar el formulario
            document.getElementById('product-form').reset();
        });

        /** Elimina un producto por su ID. */
        function deleteProduct(id) {
            // Usar un modal de confirmación visual en lugar de window.confirm()
            const confirmed = confirm(`¿Está seguro de que desea eliminar este producto del inventario?`);
            if (confirmed) {
                products = products.filter(p => p.id !== id);
                saveProducts();
                renderInventory();
                showModal("Producto Eliminado", "El producto fue eliminado exitosamente del inventario.", false);
            }
        }
        
        // --- Renderizado y Cálculos ---

        /** Renderiza la tabla de inventario y calcula los totales. */
        function renderInventory() {
            loadExchangeRate(); // Asegura que la tasa esté cargada
            loadProducts(); // Asegura que los productos estén cargados
            const body = document.getElementById('inventory-body');
            const emptyMessage = document.getElementById('empty-message');
            const exportBtn = document.getElementById('export-btn');

            body.innerHTML = '';
            let totalUSD = 0;
            let totalBs = 0;

            if (products.length === 0) {
                emptyMessage.style.display = 'block';
                exportBtn.disabled = true;
            } else {
                emptyMessage.style.display = 'none';
                exportBtn.disabled = false;
            }

            products.forEach(product => {
                const subtotalUSD = product.priceUSD * product.quantity;
                const subtotalBs = exchangeRate > 0 ? subtotalUSD * exchangeRate : 0;

                totalUSD += subtotalUSD;
                totalBs += subtotalBs;

                const row = body.insertRow();
                row.className = 'bg-white border-b hover:bg-gray-50';

                // Producto
                row.insertCell().textContent = product.name;

                // Cantidad
                row.insertCell().textContent = product.quantity;
                row.cells[1].className = 'text-center';

                // Precio ($)
                row.insertCell().textContent = formatUsd(product.priceUSD);
                row.cells[2].className = 'text-right font-medium text-secondary-usd';

                // Subtotal (Bs.)
                const subtotalCell = row.insertCell();
                if (exchangeRate > 0) {
                    subtotalCell.textContent = formatBs(subtotalBs);
                    subtotalCell.className = 'text-right font-bold text-primary-bs';
                } else {
                    subtotalCell.textContent = 'Tasa no fijada';
                    subtotalCell.className = 'text-right text-gray-400';
                          }
                
                // Acción (Eliminar)
                const actionCell = row.insertCell();
                actionCell.className = 'text-center';
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `<svg class="w-5 h-5 text-red-500 hover:text-red-700 transition duration-150" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
                deleteBtn.title = 'Eliminar producto';
                deleteBtn.onclick = () => deleteProduct(product.id);
                actionCell.appendChild(deleteBtn);
            });

            // Actualizar totales generales
            document.getElementById('total-usd').textContent = formatUsd(totalUSD);
            document.getElementById('total-bs').textContent = exchangeRate > 0 ? formatBs(totalBs) : 'N/A';
            document.getElementById('total-bs').className = exchangeRate > 0 ? 'text-primary-bs ml-2 text-lg' : 'text-gray-400 ml-2 text-lg';
        }


        // --- Exportación a PDF ---

        /** Exporta el inventario y totales a un archivo PDF. */
        function exportToPDF() {
            if (products.length === 0) {
                showModal("Error de Exportación", "No hay productos para exportar.", true);
                return;
            }

            const jsPDF = doc;
            const pdf = new jsPDF('p', 'mm', 'a4'); // 'p' for portrait, 'mm' units, 'a4' size
            const date = new Date().toLocaleDateString('es-VE');
            const time = new Date().toLocaleTimeString('es-VE');

            // --- Encabezado ---
            pdf.setFontSize(18);
            pdf.text('Reporte de Inventario', 14, 20);
            pdf.setFontSize(10);
            pdf.text(`Fecha de Reporte: ${date} ${time}`, 14, 26);
            pdf.text(`Tasa de Cambio (1 USD): ${formatBs(exchangeRate)}`, 14, 32);
            
            // --- Datos de la Tabla ---

            const headers = [
                ['Producto', 'Cant.', 'Precio Unit. (USD)', 'Subtotal (USD)', 'Subtotal (Bs.)']
            ];

            let totalUSD = 0;
            let totalBs = 0;

            const bodyData = products.map(p => {
                const subtotalUSD = p.priceUSD * p.quantity;
                const subtotalBs = p.priceUSD * p.quantity * exchangeRate;

                totalUSD += subtotalUSD;
                totalBs += subtotalBs;

                // Usar formato simple para la tabla PDF, jspdf-autotable prefiere strings sin formato de moneda.
                return [
                    p.name,
                    p.quantity.toFixed(0),
                    p.priceUSD.toFixed(2),
                    subtotalUSD.toFixed(2),
                    exchangeRate > 0 ? subtotalBs.toFixed(2) : 'N/A'
                ];
            });

            pdf.autoTable({
                head: headers,
                body: bodyData,
                startY: 40,
                theme: 'striped',
                headStyles: { fillColor: [74, 124, 89], textColor: 255 }, // Color primario (Bs.)
                styles: { fontSize: 10, cellPadding: 2 },
                columnStyles: {
                    0: { cellWidth: 50 },
                    1: { halign: 'center' },
                    2: { halign: 'right' },
                    3: { halign: 'right', fontStyle: 'bold' },
                    4: { halign: 'right', fontStyle: 'bold' }
                },
                didParseCell: (data) => {
                    // Añadir el símbolo de moneda en la vista final del PDF
                    if (data.section === 'body') {
                        if (data.column.index === 2 || data.column.index === 3) {
                            if (data.cell.text[0] !== 'N/A') {
                                data.cell.text[0] = '$' + data.cell.text[0];
                            }
                        } else if (data.column.index === 4) {
                            if (data.cell.text[0] !== 'N/A') {
                                data.cell.text[0] = 'Bs. ' + data.cell.text[0];
                            }
                        }
                    }
                }
            });
            
            // --- Totales Finales ---

            const finalY = pdf.lastAutoTable.finalY + 10;
            pdf.setFontSize(12);
            pdf.setTextColor(51, 51, 51); // Negro oscuro
            pdf.text(`Totales Generales:`, 14, finalY);

            pdf.setFontSize(14);
            pdf.setTextColor(0, 56, 101); // Azul (USD)
            pdf.text(`Total USD: ${formatUsd(totalUSD)}`, 14, finalY + 7);

            pdf.setTextColor(74, 124, 89); // Verde (Bs.)
            pdf.text(`Total Bs.: ${exchangeRate > 0 ? formatBs(totalBs) : 'Tasa no fijada'}`, 14, finalY + 14);

            // --- Footer ---
            pdf.setFontSize(8);
            pdf.setTextColor(150);
            pdf.text('Generado por Inventario Offline -  ', 14, 290, { align: 'left' });


            // Guardar el PDF
            pdf.save(`Inventario_${date}.pdf`);
        }

        /** Inicializa la aplicación al cargar la página. */
        window.onload = function() {
            // Reemplazar window.confirm con una implementación simple para evitar problemas de iframe
            window.confirm = (message) => {
                const modal = document.getElementById('message-modal');
                const titleEl = document.getElementById('modal-title');
                const bodyEl = document.getElementById('modal-body');

                titleEl.textContent = 'Confirmar Acción';
                titleEl.className = 'text-lg font-bold mb-3 text-primary-bs';
                bodyEl.textContent = message;

                return new Promise((resolve) => {
                    const confirmButton = document.createElement('button');
                    confirmButton.textContent = 'Sí, continuar';
                    confirmButton.className = 'px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 mr-2';
                    confirmButton.onclick = () => {
                        hideModal();
                        resolve(true);
                    };
                    
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'Cancelar';
                    cancelButton.className = 'px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300';
                    cancelButton.onclick = () => {
                        hideModal();
                        resolve(false);
                    };

                    // Limpiar y añadir botones
                    const footer = modal.querySelector('.flex.justify-end');
                    footer.innerHTML = '';
                    footer.appendChild(confirmButton);
                    footer.appendChild(cancelButton);

                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                });
            };

            renderInventory(); // Inicializa la vista con los datos guardados
        };
    </script>
</body>
</html>
